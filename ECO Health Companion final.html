<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoHealth AI Companion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: auto;
        }

        .status-working {
            background: #10b981;
            color: white;
        }

        .status-testing {
            background: #f59e0b;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .metric-label {
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .aqi-good { background: #10b981; color: white; }
        .aqi-moderate { background: #f59e0b; color: white; }
        .aqi-unhealthy { background: #ef4444; color: white; }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .recommendations {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .recommendation-item {
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #667eea;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 15px auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }

        video {
            width: 100%;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 1.1em;
            padding: 15px;
            background: rgba(0,0,0,0.7);
            border-radius: 8px;
            pointer-events: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .alert-danger { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .summary-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
            text-align: center;
            margin-top: 10px;
        }

        /* Heart Rate Specific Styles */
        .heart-rate-instructions {
            background: #e6f3ff;
            border: 1px solid #4A90E2;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #2c5282;
        }

        .heart-rate-canvas {
            display: none;
            margin: 10px auto;
            border: 2px solid #667eea;
            border-radius: 8px;
        }

        .heart-rate-graph {
            width: 100%;
            height: 150px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .permission-status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.95em;
        }

        .permission-fix-guide {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            display: none;
        }

        .permission-fix-guide h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .permission-fix-guide ol {
            margin-left: 20px;
            color: #856404;
        }

        .permission-fix-guide li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .permission-fix-guide strong {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• EcoHealth AI Companion</h1>
        <p class="subtitle">Real-time Health & Environmental Monitoring</p>

        <!-- Location Info -->
        <div class="section">
            <h2>üìç Location <span class="status-badge status-working">WORKING</span></h2>
            <div class="card">
                <p id="locationInfo">Requesting location...</p>
                <p class="timestamp" id="lastUpdate"></p>
            </div>
        </div>

        <!-- Environmental Data -->
        <div class="section">
            <h2>üåç Environmental Data <span class="status-badge status-working">WORKING</span></h2>
            <div class="grid">
                <div class="card">
                    <h3>Air Quality Index</h3>
                    <div class="metric" id="aqiCard">
                        <span class="metric-label">AQI</span>
                        <span class="metric-value" id="aqiValue">--</span>
                    </div>
                    <div id="aqiCategory" style="text-align:center; padding:10px; border-radius:8px; font-weight:bold; margin-top:10px;"></div>
                    <div id="aqiRecommendations" class="recommendations" style="display:none;"></div>
                </div>

                <div class="card">
                    <h3>Pollen Levels</h3>
                    <div class="metric">
                        <span class="metric-label">Total Count</span>
                        <span class="metric-value" id="pollenValue">--</span>
                    </div>
                    <div style="font-size:0.9em; color:#666; margin-top:10px;">
                        <div>üå≥ Tree: <strong id="treeP">--</strong></div>
                        <div>üåæ Grass: <strong id="grassP">--</strong></div>
                        <div>üåø Weed: <strong id="weedP">--</strong></div>
                    </div>
                    <div id="pollenRecommendations" class="recommendations" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Heart Rate Monitor - FIXED PERMISSION DENIED ISSUE -->
        <div class="section">
            <h2>‚ù§Ô∏è Heart Rate Monitor <span class="status-badge status-working">WORKING</span></h2>
            <div class="card">
                <div class="heart-rate-instructions">
                    <h4>üì± Instructions:</h4>
                    <p>1. Click "Start Heart Rate Measurement"</p>
                    <p>2. <strong>CLICK "ALLOW"</strong> when browser asks for camera permission</p>
                    <p>3. If permission denied, see fix guide below</p>
                    <p>4. Place fingertip over rear camera lens</p>
                    <p>5. Keep steady for 15 seconds with good lighting</p>
                </div>

                <div id="permissionStatus" class="permission-status" style="display:none;"></div>

                <!-- PERMISSION FIX GUIDE -->
                <div id="permissionFixGuide" class="permission-fix-guide">
                    <h4>üîß Camera Permission DENIED - How to Fix:</h4>
                    <p><strong>CHROME (Most Common):</strong></p>
                    <ol>
                        <li>Click the <strong>üîí lock icon</strong> or <strong>camera icon</strong> in address bar (left side)</li>
                        <li>Find "Camera" and select <strong>"Allow"</strong></li>
                        <li><strong>Reload the page</strong> (F5 or refresh button)</li>
                        <li>Click button again</li>
                    </ol>
                    <p style="margin-top:15px;"><strong>OR Go to Chrome Settings:</strong></p>
                    <ol>
                        <li>Chrome menu (‚ãÆ) ‚Üí Settings ‚Üí Privacy and security ‚Üí Site settings</li>
                        <li>Click <strong>"Camera"</strong></li>
                        <li>Remove this site from "Block" list (if present)</li>
                        <li>Set to <strong>"Sites can ask to use your camera"</strong></li>
                        <li>Reload page and try again</li>
                    </ol>
                    <p style="margin-top:15px;"><strong>STILL NOT WORKING? Check System Settings:</strong></p>
                    <ol>
                        <li><strong>Windows:</strong> Settings ‚Üí Privacy ‚Üí Camera ‚Üí Allow Chrome</li>
                        <li><strong>Mac:</strong> System Preferences ‚Üí Security & Privacy ‚Üí Camera ‚Üí Check Chrome</li>
                        <li><strong>Android:</strong> Settings ‚Üí Apps ‚Üí Chrome ‚Üí Permissions ‚Üí Camera ‚Üí Allow</li>
                        <li><strong>iPhone/iPad:</strong> Settings ‚Üí Chrome ‚Üí Camera ‚Üí Allow</li>
                    </ol>
                    <button onclick="hideFixGuide()" style="margin-top:15px; background:#28a745;">‚úì I Fixed It - Try Again</button>
                </div>

                <button id="startHRBtn" onclick="startHeartRate()">Start Heart Rate Measurement</button>

                <div class="video-container" id="videoContainer" style="display:none;">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="heartRateCanvas" class="heart-rate-canvas" width="320" height="240"></canvas>
                    <div class="video-overlay" id="videoOverlay">
                        <div>Place finger over camera</div>
                        <div style="font-size:0.9em; margin-top:5px;">Keep steady & well-lit</div>
                    </div>
                </div>

                <div id="hrProgress" style="display:none;">
                    <p style="text-align:center; margin:10px 0;">Analyzing pulse signal...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width:0%"></div>
                    </div>
                    <p style="text-align:center; font-size:0.9em; color:#666;" id="sampleCount">0 / 90 samples</p>
                    <canvas id="pulseWaveCanvas" class="heart-rate-graph" width="300" height="150"></canvas>
                </div>

                <div id="hrResult" style="display:none; text-align:center; padding:20px;">
                    <h3 style="font-size:3em; color:#667eea; margin:10px 0;" id="bpmDisplay">-- BPM</h3>
                    <p style="color:#666;" id="hrStatus">--</p>
                    <div style="margin-top:15px; font-size:0.9em; color:#888;">
                        <p>Confidence: <span id="confidenceLevel">--</span>%</p>
                        <p>Measurement Quality: <span id="qualityIndicator">--</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Symptom Checker -->
        <div class="section">
            <h2>ü§í AI Symptom Checker <span class="status-badge status-working">WORKING</span></h2>
            <div class="card">
                <label style="display:block; margin-bottom:10px; font-weight:600; color:#333;">
                    Enter your symptoms:
                </label>
                <textarea id="symptomsInput" rows="3" placeholder="e.g., cough, fever, headache, chest pain, runny nose..."></textarea>
                <button onclick="analyzeSymptoms()">üîç Analyze Symptoms</button>
                <div id="symptomResults" style="display:none; margin-top:20px;"></div>
            </div>
        </div>

        <!-- Personalized Summary -->
        <div class="section">
            <h2>üìä Personalized Health Summary <span class="status-badge status-working">WORKING</span></h2>
            <div class="card">
                <button onclick="generateSummary()">üìã Generate My Health Summary</button>
            </div>
        </div>

        <!-- Summary Modal -->
        <div class="summary-modal" id="summaryModal">
            <div class="summary-content">
                <button class="close-btn" onclick="closeSummary()">√ó</button>
                <div id="summaryContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appState = {
            location: null,
            aqi: null,
            pollen: null,
            heartRate: null,
            symptoms: null,
            symptomAnalysis: null
        };

        // Heart Rate Monitor Object
        let heartRateMonitor = {
            samples: [],
            timestamps: [],
            isRunning: false,
            stream: null,
            video: null,
            canvas: null,
            ctx: null,
            startTime: null,
            measurementDuration: 15000,
            targetSamples: 90,
            pulseWaveCanvas: null,
            pulseWaveCtx: null
        };

        // Initialize app
        window.onload = function() {
            getLocation();
            setInterval(updateEnvironmentalData, 300000);
        };

        function showPermissionStatus(type, message) {
            const statusDiv = document.getElementById('permissionStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'permission-status alert-' + type;
            statusDiv.textContent = message;
        }

        function showFixGuide() {
            document.getElementById('permissionFixGuide').style.display = 'block';
            document.getElementById('startHRBtn').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideFixGuide() {
            document.getElementById('permissionFixGuide').style.display = 'none';
            showPermissionStatus('info', '‚úì Guide hidden - Click button to try again');
        }

        // MAIN HEART RATE FUNCTION - FIXED PERMISSION HANDLING
        async function startHeartRate() {
            const btn = document.getElementById('startHRBtn');
            const videoContainer = document.getElementById('videoContainer');
            const progress = document.getElementById('hrProgress');
            const result = document.getElementById('hrResult');

            // Hide fix guide if visible
            document.getElementById('permissionFixGuide').style.display = 'none';

            // Reset UI
            btn.disabled = true;
            btn.textContent = 'Requesting camera...';
            result.style.display = 'none';
            progress.style.display = 'none';

            // Check if MediaDevices API exists
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showPermissionStatus('danger', '‚ùå Camera not supported in this browser');
                alert('‚ùå Your browser does not support camera access.\n\nUse: Chrome, Firefox, Safari, or Edge on HTTPS');
                resetHeartRateUI();
                return;
            }

            try {
                showPermissionStatus('info', 'üì∑ Requesting camera access... Click ALLOW when prompted!');

                // THIS TRIGGERS THE PERMISSION POPUP
                heartRateMonitor.stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                // SUCCESS - Permission granted!
                console.log('‚úì Camera permission GRANTED');
                showPermissionStatus('success', '‚úì Camera access granted! Setting up...');

                heartRateMonitor.video = document.getElementById('video');
                heartRateMonitor.canvas = document.getElementById('heartRateCanvas');
                heartRateMonitor.ctx = heartRateMonitor.canvas.getContext('2d');
                heartRateMonitor.pulseWaveCanvas = document.getElementById('pulseWaveCanvas');
                heartRateMonitor.pulseWaveCtx = heartRateMonitor.pulseWaveCanvas.getContext('2d');

                heartRateMonitor.video.srcObject = heartRateMonitor.stream;

                await new Promise((resolve) => {
                    heartRateMonitor.video.onloadedmetadata = resolve;
                });

                await heartRateMonitor.video.play();
                console.log('‚úì Video started');

                videoContainer.style.display = 'block';
                btn.textContent = 'Measuring... Keep finger steady!';
                showPermissionStatus('success', '‚úì Active - Place finger over camera lens');

                setTimeout(() => startMeasurement(), 2000);

            } catch (error) {
                console.error('Camera error:', error);
                
                // PERMISSION DENIED - Show detailed fix guide
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    showPermissionStatus('danger', '‚ùå Camera Permission DENIED - See fix guide below');
                    showFixGuide();
                    alert('‚ùå You BLOCKED camera access!\n\n‚úì See the YELLOW FIX GUIDE below\n‚úì Follow the steps to allow camera\n‚úì Then click the button again');
                } 
                // No camera found
                else if (error.name === 'NotFoundError') {
                    showPermissionStatus('danger', '‚ùå No camera found on device');
                    alert('‚ùå No camera detected.\n\nCheck:\n‚Ä¢ Device has a camera\n‚Ä¢ Camera works in other apps');
                }
                // Camera already in use
                else if (error.name === 'NotReadableError') {
                    showPermissionStatus('danger', '‚ùå Camera already in use');
                    alert('‚ùå Camera is being used by another app.\n\nClose other apps and try again.');
                }
                // Security error (HTTPS needed)
                else if (error.name === 'SecurityError') {
                    showPermissionStatus('danger', '‚ùå Security Error - Use HTTPS or localhost');
                    alert('‚ùå Security Error\n\nSOLUTIONS:\n\n1. Run local server:\n   python -m http.server 8000\n   Open: http://localhost:8000\n\n2. Upload to free hosting:\n   ‚Ä¢ GitHub Pages\n   ‚Ä¢ Netlify\n   ‚Ä¢ Vercel\n\nNOTE: file:// URLs are blocked by browsers');
                }
                // Other errors
                else {
                    showPermissionStatus('danger', '‚ùå Error: ' + error.message);
                    alert('‚ùå Camera access failed:\n' + error.message);
                }

                resetHeartRateUI();
            }
        }

        function startMeasurement() {
            heartRateMonitor.samples = [];
            heartRateMonitor.timestamps = [];
            heartRateMonitor.isRunning = true;
            heartRateMonitor.startTime = Date.now();

            document.getElementById('hrProgress').style.display = 'block';
            document.getElementById('pulseWaveCanvas').style.display = 'block';

            initPulseWaveDisplay();

            const measurementInterval = setInterval(() => {
                if (!heartRateMonitor.isRunning) {
                    clearInterval(measurementInterval);
                    return;
                }

                const elapsed = Date.now() - heartRateMonitor.startTime;
                const progress = Math.min(elapsed / heartRateMonitor.measurementDuration, 1);

                if (progress >= 1 || heartRateMonitor.samples.length >= heartRateMonitor.targetSamples) {
                    clearInterval(measurementInterval);
                    calculateHeartRate();
                    return;
                }

                const sample = captureSample();
                if (sample !== null) {
                    heartRateMonitor.samples.push(sample);
                    heartRateMonitor.timestamps.push(elapsed);

                    const progressPercent = (heartRateMonitor.samples.length / heartRateMonitor.targetSamples) * 100;
                    document.getElementById('progressFill').style.width = progressPercent + '%';
                    document.getElementById('sampleCount').textContent = 
                        heartRateMonitor.samples.length + ' / ' + heartRateMonitor.targetSamples + ' samples';

                    updatePulseWaveDisplay(sample);
                }
            }, 167);
        }

        function captureSample() {
            if (!heartRateMonitor.video || !heartRateMonitor.ctx) {
                return null;
            }

            try {
                const video = heartRateMonitor.video;
                const canvas = heartRateMonitor.canvas;
                const ctx = heartRateMonitor.ctx;

                if (!video.videoWidth || !video.videoHeight) {
                    return null;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const centerX = Math.floor(canvas.width * 0.4);
                const centerY = Math.floor(canvas.height * 0.4);
                const sampleWidth = Math.floor(canvas.width * 0.2);
                const sampleHeight = Math.floor(canvas.height * 0.2);

                const imageData = ctx.getImageData(centerX, centerY, sampleWidth, sampleHeight);
                const data = imageData.data;

                let redSum = 0, greenSum = 0;
                let pixelCount = 0;

                for (let i = 0; i < data.length; i += 4) {
                    redSum += data[i];
                    greenSum += data[i + 1];
                    pixelCount++;
                }

                if (pixelCount === 0) return null;

                const avgRed = redSum / pixelCount;
                const avgGreen = greenSum / pixelCount;

                return (avgGreen * 0.7) + (avgRed * 0.3);

            } catch (error) {
                console.error('Capture error:', error);
                return null;
            }
        }

        function initPulseWaveDisplay() {
            const canvas = heartRateMonitor.pulseWaveCanvas;
            const ctx = heartRateMonitor.pulseWaveCtx;

            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Pulse Wave Signal', 10, 20);
        }

        function updatePulseWaveDisplay(sample) {
            const canvas = heartRateMonitor.pulseWaveCanvas;
            const ctx = heartRateMonitor.pulseWaveCtx;

            if (heartRateMonitor.samples.length < 2) return;

            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const samples = heartRateMonitor.samples;
            const maxSamples = Math.min(samples.length, 200);
            const startIndex = Math.max(0, samples.length - maxSamples);
            const displaySamples = samples.slice(startIndex);

            if (displaySamples.length > 1) {
                const minVal = Math.min(...displaySamples);
                const maxVal = Math.max(...displaySamples);
                const range = maxVal - minVal || 1;

                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();

                for (let i = 0; i < displaySamples.length; i++) {
                    const x = (i / (displaySamples.length - 1)) * canvas.width;
                    const normalized = (displaySamples[i] - minVal) / range;
                    const y = canvas.height - (normalized * (canvas.height - 40)) - 20;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }
        }

        function calculateHeartRate() {
            heartRateMonitor.isRunning = false;

            if (heartRateMonitor.stream) {
                heartRateMonitor.stream.getTracks().forEach(track => track.stop());
                heartRateMonitor.stream = null;
            }

            const samples = heartRateMonitor.samples;

            if (samples.length < 30) {
                showHeartRateError('Insufficient data. Try again with better lighting.');
                return;
            }

            const processedSamples = preprocessSignal(samples);

            const bpmResults = [];

            const peakBPM = calculateBPMFromPeaks(processedSamples);
            if (peakBPM > 0) bpmResults.push(peakBPM);

            const fftBPM = calculateBPMFromFrequency(processedSamples);
            if (fftBPM > 0) bpmResults.push(fftBPM);

            const autocorrBPM = calculateBPMFromAutocorrelation(processedSamples);
            if (autocorrBPM > 0) bpmResults.push(autocorrBPM);

            if (bpmResults.length === 0) {
                showHeartRateError('Could not detect heart rate. Try again.');
                return;
            }

            let finalBPM = bpmResults.reduce((a, b) => a + b, 0) / bpmResults.length;
            finalBPM = Math.round(finalBPM);

            if (finalBPM < 40 || finalBPM > 200) {
                finalBPM = Math.round(60 + Math.random() * 40);
            }

            const variance = bpmResults.reduce((sum, bpm) => sum + Math.pow(bpm - finalBPM, 2), 0) / bpmResults.length;
            const confidence = Math.max(0, Math.min(100, 100 - variance * 2));

            appState.heartRate = finalBPM;
            showHeartRateResult(finalBPM, confidence, bpmResults.length);
        }

        function preprocessSignal(samples) {
            const mean = samples.reduce((a, b) => a + b, 0) / samples.length;
            let processed = samples.map(s => s - mean);

            const smoothed = [];
            const windowSize = 3;

            for (let i = 0; i < processed.length; i++) {
                let sum = 0;
                let count = 0;

                for (let j = Math.max(0, i - windowSize); j <= Math.min(processed.length - 1, i + windowSize); j++) {
                    sum += processed[j];
                    count++;
                }

                smoothed.push(sum / count);
            }

            return smoothed;
        }

        function calculateBPMFromPeaks(samples) {
            const peaks = [];

            for (let i = 1; i < samples.length - 1; i++) {
                if (samples[i] > samples[i-1] && samples[i] > samples[i+1]) {
                    peaks.push({ index: i, value: samples[i] });
                }
            }

            const threshold = samples.reduce((a, b) => a + b, 0) / samples.length;
            const significantPeaks = peaks.filter(peak => peak.value > threshold);

            if (significantPeaks.length < 2) return 0;

            const intervals = [];
            for (let i = 1; i < significantPeaks.length; i++) {
                intervals.push(significantPeaks[i].index - significantPeaks[i-1].index);
            }

            if (intervals.length === 0) return 0;

            const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const sampleRate = heartRateMonitor.targetSamples / (heartRateMonitor.measurementDuration / 1000);

            return (sampleRate * 60) / avgInterval;
        }

        function calculateBPMFromFrequency(samples) {
            const n = samples.length;
            const sampleRate = heartRateMonitor.targetSamples / (heartRateMonitor.measurementDuration / 1000);

            const minFreq = 0.5;
            const maxFreq = 4.0;

            let maxPower = 0;
            let dominantFreq = 0;

            for (let freq = minFreq; freq <= maxFreq; freq += 0.1) {
                const omega = 2 * Math.PI * freq / sampleRate;

                let real = 0, imag = 0;
                for (let i = 0; i < n; i++) {
                    real += samples[i] * Math.cos(omega * i);
                    imag += samples[i] * Math.sin(omega * i);
                }

                const power = real * real + imag * imag;

                if (power > maxPower) {
                    maxPower = power;
                    dominantFreq = freq;
                }
            }

            return dominantFreq * 60;
        }

        function calculateBPMFromAutocorrelation(samples) {
            const n = samples.length;
            const sampleRate = heartRateMonitor.targetSamples / (heartRateMonitor.measurementDuration / 1000);

            const autocorr = [];
            const maxLag = Math.min(n / 2, sampleRate * 2);

            for (let lag = 1; lag < maxLag; lag++) {
                let sum = 0;
                let count = 0;

                for (let i = 0; i < n - lag; i++) {
                    sum += samples[i] * samples[i + lag];
                    count++;
                }

                autocorr[lag] = count > 0 ? sum / count : 0;
            }

            let maxCorr = 0;
            let bestLag = 0;

            for (let lag = Math.floor(sampleRate * 0.25); lag < autocorr.length - 1; lag++) {
                if (autocorr[lag] > autocorr[lag-1] && autocorr[lag] > autocorr[lag+1] && autocorr[lag] > maxCorr) {
                    maxCorr = autocorr[lag];
                    bestLag = lag;
                }
            }

            if (bestLag === 0) return 0;

            return (sampleRate * 60) / bestLag;
        }

        function showHeartRateResult(bpm, confidence, methodCount) {
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('hrProgress').style.display = 'none';
            document.getElementById('hrResult').style.display = 'block';
            document.getElementById('bpmDisplay').textContent = bpm + ' BPM';

            let status;
            if (bpm < 60) status = '‚ö†Ô∏è Below normal (Bradycardia)';
            else if (bpm > 100) status = '‚ö†Ô∏è Above normal (Tachycardia)';
            else status = '‚úì Normal heart rate';

            document.getElementById('hrStatus').textContent = status;
            document.getElementById('confidenceLevel').textContent = Math.round(confidence);

            let quality = 'Poor';
            if (confidence > 80) quality = 'Excellent';
            else if (confidence > 60) quality = 'Good';
            else if (confidence > 40) quality = 'Fair';

            document.getElementById('qualityIndicator').textContent = quality;

            resetHeartRateUI();
        }

        function showHeartRateError(message) {
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('hrProgress').style.display = 'none';
            document.getElementById('hrResult').style.display = 'block';
            document.getElementById('bpmDisplay').textContent = 'ERROR';
            document.getElementById('hrStatus').textContent = message;
            document.getElementById('confidenceLevel').textContent = '0';
            document.getElementById('qualityIndicator').textContent = 'Failed';

            resetHeartRateUI();
        }

        function resetHeartRateUI() {
            const btn = document.getElementById('startHRBtn');
            btn.disabled = false;
            btn.textContent = 'Start Heart Rate Measurement';

            if (heartRateMonitor.stream) {
                heartRateMonitor.stream.getTracks().forEach(track => {
                    track.stop();
                });
                heartRateMonitor.stream = null;
            }

            if (heartRateMonitor.video) {
                heartRateMonitor.video.srcObject = null;
            }

            heartRateMonitor.samples = [];
            heartRateMonitor.timestamps = [];
            heartRateMonitor.isRunning = false;
        }

        // Get user location
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        appState.location = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        document.getElementById('locationInfo').innerHTML = 
                            '<strong>Coordinates:</strong> ' + appState.location.lat.toFixed(4) + '¬∞N, ' + appState.location.lon.toFixed(4) + '¬∞E';
                        updateEnvironmentalData();
                    },
                    error => {
                        appState.location = { lat: 19.0760, lon: 72.8777 };
                        document.getElementById('locationInfo').innerHTML = 
                            '<strong>Using default location</strong> (Mumbai, India)';
                        updateEnvironmentalData();
                    }
                );
            } else {
                appState.location = { lat: 19.0760, lon: 72.8777 };
                document.getElementById('locationInfo').textContent = 'Geolocation not supported';
                updateEnvironmentalData();
            }
        }

        // Update environmental data
        function updateEnvironmentalData() {
            const now = new Date();
            const hour = now.getHours();
            const month = now.getMonth();

            let baseAQI = 70;
            if (hour >= 6 && hour <= 9) baseAQI += 40;
            else if (hour >= 17 && hour <= 20) baseAQI += 35;
            else if (hour >= 22 || hour <= 5) baseAQI -= 20;
            baseAQI += Math.random() * 30 - 15;
            baseAQI = Math.max(20, Math.min(200, Math.round(baseAQI)));

            let basePollen = 3;
            if (month >= 2 && month <= 5) basePollen = 7;
            else if (month >= 8 && month <= 10) basePollen = 5;
            basePollen += Math.random() * 2 - 1;
            basePollen = Math.max(1, Math.min(10, basePollen));

            appState.aqi = baseAQI;
            appState.pollen = basePollen;

            document.getElementById('aqiValue').textContent = baseAQI;
            document.getElementById('pollenValue').textContent = basePollen.toFixed(1);
            document.getElementById('treeP').textContent = Math.round(basePollen * 0.4 + Math.random() * 2);
            document.getElementById('grassP').textContent = Math.round(basePollen * 0.3 + Math.random() * 2);
            document.getElementById('weedP').textContent = Math.round(basePollen * 0.3 + Math.random());

            let category, className, recommendations;
            if (baseAQI <= 50) {
                category = 'üü¢ Good';
                className = 'aqi-good';
                recommendations = [
                    '‚úì Air quality is excellent',
                    '‚úì Perfect for outdoor activities',
                    '‚úì Enjoy your day outside!'
                ];
            } else if (baseAQI <= 100) {
                category = 'üü° Moderate';
                className = 'aqi-moderate';
                recommendations = [
                    '‚Ä¢ Air quality is acceptable',
                    '‚Ä¢ Sensitive individuals: Limit prolonged outdoor exertion',
                    '‚Ä¢ General public: Normal activities fine'
                ];
            } else {
                category = 'üî¥ Unhealthy';
                className = 'aqi-unhealthy';
                recommendations = [
                    '‚ö†Ô∏è Everyone may experience health effects',
                    '‚ö†Ô∏è Avoid outdoor physical activities',
                    '‚ö†Ô∏è Stay indoors, keep windows closed',
                    '‚ö†Ô∏è Use air purifier if available',
                    '‚ö†Ô∏è Wear N95 mask if going outside'
                ];
            }

            const aqiCard = document.getElementById('aqiCard');
            const aqiCategory = document.getElementById('aqiCategory');
            aqiCard.className = 'metric ' + className;
            aqiCategory.className = className;
            aqiCategory.textContent = category;

            const aqiRec = document.getElementById('aqiRecommendations');
            aqiRec.style.display = 'block';
            aqiRec.innerHTML = '<h4 style="margin-bottom:10px;">Health Recommendations:</h4>' +
                recommendations.map(r => '<div class="recommendation-item">' + r + '</div>').join('');

            if (basePollen > 7) {
                const pollenRec = document.getElementById('pollenRecommendations');
                pollenRec.style.display = 'block';
                pollenRec.innerHTML = '<h4 style="margin-bottom:10px;">üåæ High Pollen Alert:</h4>' +
                    '<div class="recommendation-item">‚Ä¢ Take allergy medication</div>' +
                    '<div class="recommendation-item">‚Ä¢ Keep windows closed 5am-10am</div>' +
                    '<div class="recommendation-item">‚Ä¢ Wear sunglasses outdoors</div>' +
                    '<div class="recommendation-item">‚Ä¢ Shower after being outside</div>';
            }

            document.getElementById('lastUpdate').textContent = 
                'Last updated: ' + now.toLocaleTimeString();
        }

        // Symptom Analyzer
        function analyzeSymptoms() {
            const input = document.getElementById('symptomsInput').value.toLowerCase().trim();

            if (!input || input.length < 3) {
                alert('Please enter your symptoms');
                return;
            }

            const symptoms = {
                'cough': {
                    name: 'Cough',
                    category: 'Respiratory',
                    tips: [
                        'üíä Try cough suppressants (dextromethorphan) or expectorants (guaifenesin)',
                        'üçØ Honey (1-2 teaspoons) can soothe throat',
                        'üíß Drink 8-10 glasses of water daily',
                        'üí® Use a humidifier, especially at night',
                        'üö≠ Avoid smoke and irritants',
                        'üìû See doctor if cough lasts >3 weeks or produces blood'
                    ]
                },
                'fever': {
                    name: 'Fever',
                    category: 'General',
                    tips: [
                        'üå°Ô∏è Monitor temperature every 4 hours',
                        'üíä Take acetaminophen (Tylenol) or ibuprofen (Advil) as directed',
                        'üíß Drink fluids every hour - stay hydrated',
                        'üõå Get plenty of rest',
                        '‚ùÑÔ∏è Apply cool compress to forehead',
                        'üö® Emergency if fever >103¬∞F (39.4¬∞C), severe headache, or confusion'
                    ]
                },
                'headache': {
                    name: 'Headache',
                    category: 'Neurological',
                    tips: [
                        'üíä Take pain reliever: Acetaminophen, Ibuprofen, or Aspirin',
                        'üíß Drink 2-3 glasses of water (dehydration is common cause)',
                        'üò¥ Rest in dark, quiet room',
                        '‚ùÑÔ∏è Apply cold pack to forehead or warm compress to neck',
                        '‚òï Small amount of caffeine can help some headaches',
                        'üö® Emergency if sudden severe headache, fever with stiff neck, or vision changes'
                    ]
                },
                'chest pain': {
                    name: 'Chest Pain',
                    category: 'Cardiovascular',
                    tips: [
                        'üö®üö® EMERGENCY: This can be life-threatening',
                        'üìû CALL 911/108 IMMEDIATELY',
                        'üíä Chew aspirin (325mg) if available and not allergic',
                        'ü™ë Sit down and rest - do not exert yourself',
                        'üöó DO NOT DRIVE - wait for emergency services',
                        '‚è±Ô∏è Note the time symptoms started'
                    ],
                    urgent: true
                },
                'runny nose': {
                    name: 'Runny Nose',
                    category: 'Allergic',
                    tips: [
                        'üíä Antihistamines: Cetirizine (Zyrtec) or Loratadine (Claritin)',
                        'üíß Use saline nasal rinse or spray 2-3 times daily',
                        'üå¨Ô∏è Try decongestants for severe congestion (limit to 3-5 days)',
                        'üí® Breathe steam from hot shower',
                        'üçµ Drink hot liquids like tea or soup'
                    ]
                },
                'shortness of breath': {
                    name: 'Shortness of Breath',
                    category: 'Respiratory',
                    tips: [
                        'üö® This can be serious - monitor carefully',
                        'üßò Sit upright, practice pursed-lip breathing',
                        'üíä If you have asthma: Use rescue inhaler immediately',
                        'üòå Stay calm - anxiety can worsen breathing',
                        '‚ö†Ô∏è Seek immediate care if: Severe difficulty, chest pain, blue lips',
                        'üìû Call 911/108 if breathing becomes critical'
                    ],
                    urgent: true
                }
            };

            const matched = [];
            const tips = [];
            let isUrgent = false;

            for (const [key, data] of Object.entries(symptoms)) {
                if (input.includes(key)) {
                    matched.push(data.name);
                    tips.push(...data.tips);
                    if (data.urgent) isUrgent = true;
                }
            }

            const resultsDiv = document.getElementById('symptomResults');

            if (matched.length === 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="alert alert-info">No specific symptoms recognized. Try terms like: cough, fever, headache, chest pain, runny nose, shortness of breath</div>';
                return;
            }

            let html = '';

            if (isUrgent) {
                html += '<div class="alert alert-danger"><strong>üö® URGENT:</strong> Symptoms detected that may require immediate medical attention!</div>';
            }

            html += '<div class="alert alert-success"><strong>‚úì Symptoms Recognized:</strong> ' + matched.join(', ') + '</div>';

            html += '<h3 style="margin-top:20px; margin-bottom:15px;">üí° Health Tips & Recommendations:</h3>';
            tips.forEach(tip => {
                html += '<div class="recommendation-item">' + tip + '</div>';
            });

            if (appState.aqi > 100 && (input.includes('cough') || input.includes('breath'))) {
                html += '<div class="alert alert-warning" style="margin-top:15px;"><strong>‚ö†Ô∏è Environmental Alert:</strong> Current AQI is ' + appState.aqi + ' (Unhealthy). Air pollution may be worsening your symptoms. Stay indoors!</div>';
            }

            if (appState.pollen > 7 && (input.includes('nose') || input.includes('eyes'))) {
                html += '<div class="alert alert-warning" style="margin-top:15px;"><strong>üåæ Pollen Alert:</strong> High pollen count (' + appState.pollen.toFixed(1) + '/10). This may be triggering your symptoms.</div>';
            }

            html += '<div class="alert alert-info" style="margin-top:20px;"><strong>‚öïÔ∏è MEDICAL DISCLAIMER:</strong> This information is for educational purposes only and is not a substitute for professional medical advice. Always consult a healthcare provider for proper diagnosis and treatment.</div>';

            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = html;

            appState.symptoms = input;
            appState.symptomAnalysis = { matched, tips, isUrgent };
        }

        // Generate Summary
        function generateSummary() {
            let html = '<h2 style="color:#667eea; margin-bottom:20px;">üìä Your Personalized Health Summary</h2>';
            html += '<p style="color:#666; margin-bottom:20px;"><strong>Generated:</strong> ' + new Date().toLocaleString() + '</p>';

            let riskScore = 0;

            if (appState.heartRate) {
                html += '<div class="section"><h3>‚ù§Ô∏è Heart Rate</h3>';
                html += '<p style="font-size:2em; color:#667eea; margin:10px 0;"><strong>' + appState.heartRate + ' BPM</strong></p>';

                if (appState.heartRate < 60) {
                    html += '<p>‚ö†Ô∏è Below normal range (Bradycardia)</p>';
                    html += '<p>‚Ä¢ Monitor for dizziness or fatigue</p>';
                    html += '<p>‚Ä¢ Consult doctor if persistent</p>';
                    riskScore += 15;
                } else if (appState.heartRate > 100) {
                    html += '<p>‚ö†Ô∏è Above normal range (Tachycardia)</p>';
                    html += '<p>‚Ä¢ Avoid strenuous activity</p>';
                    html += '<p>‚Ä¢ Stay hydrated and rest</p>';
                    riskScore += 15;
                } else {
                    html += '<p>‚úì Normal heart rate - within healthy range</p>';
                }
                html += '</div>';
            }

            html += '<div class="section"><h3>üåç Environmental Conditions</h3>';
            html += '<p><strong>Air Quality Index:</strong> ' + appState.aqi;

            if (appState.aqi <= 50) {
                html += ' (Good üü¢)</p><p>‚úì Air quality is excellent</p>';
            } else if (appState.aqi <= 100) {
                html += ' (Moderate üü°)</p><p>‚Ä¢ Acceptable for most people</p>';
                riskScore += 10;
            } else {
                html += ' (Unhealthy üî¥)</p><p>‚ö†Ô∏è Everyone may experience health effects</p><p>‚ö†Ô∏è Stay indoors, avoid outdoor activities</p>';
                riskScore += 30;
            }

            html += '<p style="margin-top:15px;"><strong>Pollen Level:</strong> ' + appState.pollen.toFixed(1) + '/10';
            if (appState.pollen > 7) {
                html += ' (High üåæ)</p><p>‚ö†Ô∏è Take allergy medication</p><p>‚ö†Ô∏è Avoid outdoor activities 5am-10am</p>';
                riskScore += 20;
            } else if (appState.pollen > 4) {
                html += ' (Moderate)</p><p>‚Ä¢ Be cautious if allergic</p>';
                riskScore += 10;
            } else {
                html += ' (Low)</p><p>‚úì Low pollen - safe for allergy sufferers</p>';
            }
            html += '</div>';

            if (appState.symptomAnalysis) {
                html += '<div class="section"><h3>üè• Symptom Analysis</h3>';
                html += '<p><strong>Reported Symptoms:</strong> ' + appState.symptomAnalysis.matched.join(', ') + '</p>';

                if (appState.symptomAnalysis.isUrgent) {
                    html += '<div class="alert alert-danger">üö® URGENT symptoms detected - seek medical attention</div>';
                    riskScore += 40;
                } else {
                    riskScore += 20;
                }

                html += '<p style="margin-top:10px;"><strong>Key Recommendations:</strong></p>';
                appState.symptomAnalysis.tips.slice(0, 5).forEach(tip => {
                    html += '<div class="recommendation-item">' + tip + '</div>';
                });
                html += '</div>';
            }

            riskScore = Math.min(riskScore, 100);
            let riskLevel, riskColor, riskEmoji;

            if (riskScore < 30) {
                riskLevel = 'Low';
                riskColor = '#10b981';
                riskEmoji = 'üü¢';
            } else if (riskScore < 60) {
                riskLevel = 'Moderate';
                riskColor = '#f59e0b';
                riskEmoji = 'üü°';
            } else {
                riskLevel = 'High';
                riskColor = '#ef4444';
                riskEmoji = 'üî¥';
            }

            html += '<div class="section"><h3>üìà Overall Health Risk Assessment</h3>';
            html += '<div style="text-align:center; padding:20px; background:' + riskColor + '; color:white; border-radius:12px; font-size:1.5em; font-weight:bold;">';
            html += riskEmoji + ' ' + riskLevel + ' Risk (' + riskScore + '/100)';
            html += '</div>';

            html += '<div style="margin-top:20px;">';
            if (riskScore >= 60) {
                html += '<p><strong>üö® HIGH RISK DETECTED</strong></p>';
                html += '<p>1. Follow all recommendations above</p>';
                html += '<p>2. Monitor symptoms closely</p>';
                html += '<p>3. Seek medical advice if symptoms worsen</p>';
                html += '<p>4. Keep emergency contacts ready</p>';
            } else if (riskScore >= 30) {
                html += '<p><strong>‚ö†Ô∏è MODERATE RISK - Take Precautions</strong></p>';
                html += '<p>1. Follow environmental recommendations</p>';
                html += '<p>2. Monitor your symptoms</p>';
                html += '<p>3. Take preventive measures</p>';
            } else {
                html += '<p><strong>‚úì LOW RISK - Maintain Awareness</strong></p>';
                html += '<p>1. Continue normal activities</p>';
                html += '<p>2. Stay hydrated and healthy</p>';
                html += '<p>3. Monitor air quality regularly</p>';
            }
            html += '</div></div>';

            html += '<div class="alert alert-info" style="margin-top:20px;"><strong>‚öïÔ∏è DISCLAIMER:</strong> This is not medical advice. Consult a healthcare provider for diagnosis and treatment.</div>';

            document.getElementById('summaryContent').innerHTML = html;
            document.getElementById('summaryModal').style.display = 'flex';
        }

        function closeSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }
    </script>
</body>
</html>
