<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoHealth AI Companion - Accurate PPG</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            margin: 5px;
            font-weight: 600;
        }
        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }
        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .coord-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .divider {
            text-align: center;
            margin: 15px 0;
            color: #999;
            position: relative;
        }
        .divider::before, .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 42%;
            height: 1px;
            background: #ddd;
        }
        .divider::before { left: 0; }
        .divider::after { right: 0; }
        .aqi-display {
            text-align: center;
            padding: 30px;
            border-radius: 12px;
            margin: 20px 0;
            color: white;
        }
        .aqi-value {
            font-size: 4em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .aqi-category {
            font-size: 1.4em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .pollutants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 15px 0;
        }
        .pollutant-card {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .pollutant-card.primary {
            background: linear-gradient(135deg, #FFE0B2, #FFCC80);
            border: 2px solid #FF9800;
        }
        .pollutant-name {
            font-size: 0.8em;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .pollutant-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }
        .recommendations {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .recommendation-item {
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #667eea;
            background: white;
            border-radius: 4px;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .alert-danger { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .loading {
            text-align: center;
            padding: 30px;
            color: #667eea;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }
        .video-container {
            position: relative;
            max-width: 300px;
            margin: 15px auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            display: none;
        }
        video { width: 100%; display: block; }
        .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }
        canvas { display: none; }
        .heart-rate-graph {
            width: 100%;
            height: 150px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
        }
        .quality-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .quality-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        .quality-good { background: #10b981; }
        .quality-fair { background: #f59e0b; }
        .quality-poor { background: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .summary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .summary-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
        }
        /* Added styles for symptom autocomplete */
        .symptom-input-container {
            position: relative;
        }
        .symptom-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .symptom-suggestions.active {
            display: block;
        }
        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        .suggestion-item:hover {
            background: #f0f4ff;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-category {
            font-size: 0.75em;
            color: #888;
            margin-left: 8px;
        }
        .selected-symptoms {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .symptom-tag {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .symptom-tag-remove {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }
        .symptom-tag-remove:hover {
            opacity: 1;
        }
        /* Added location accuracy indicator styles */
        .location-info {
            background: #f0f4ff;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .location-info .accuracy {
            color: #667eea;
            font-weight: 600;
        }
        .pollen-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .pollen-card {
            background: linear-gradient(135deg, #f5f7fa, #e8f5e9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .pollen-card.high {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border: 2px solid #ff9800;
        }
        .pollen-card.very-high {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 2px solid #f44336;
        }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .coord-group { grid-template-columns: 1fr; }
            .aqi-value { font-size: 3em; }
            .pollen-details { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EcoHealth AI Companion</h1>
            <p>Complete Health & Environmental Monitoring</p>
            <div style="margin-top:15px;">
                <span class="badge">Accurate PPG</span>
                <span class="badge">30 Hz Sampling</span>
                <span class="badge">Government AQI</span>
                <span class="badge">100% Client-Side</span>
            </div>
        </div>

        <!-- AQI Section -->
        <div class="section">
            <h2>Air Quality Index</h2>
            <div class="form-group">
                <label>Select Country</label>
                <select id="country">
                    <option value="">-- Select Country --</option>
                    <option value="India">India (CPCB)</option>
                    <option value="USA">USA (EPA)</option>
                    <option value="UK">United Kingdom</option>
                    <option value="Canada">Canada</option>
                    <option value="Australia">Australia</option>
                    <option value="France">France</option>
                    <option value="Germany">Germany</option>
                    <option value="China">China</option>
                    <option value="Japan">Japan</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>City Name</label>
                <input type="text" id="city" placeholder="e.g., Delhi, New York, London, Tokyo">
            </div>
            <div class="divider">OR</div>
            <div class="form-group">
                <label>Coordinates</label>
                <div class="coord-group">
                    <input type="number" id="lat" placeholder="Latitude" step="0.000001">
                    <input type="number" id="lon" placeholder="Longitude" step="0.000001">
                </div>
            </div>
            <!-- Added location info display -->
            <div id="locationInfo" class="location-info" style="display:none;"></div>
            <button onclick="getAQI()">Get AQI Index</button>
            <button id="locationBtn" onclick="useMyLocation()" style="background: linear-gradient(135deg, #10b981, #059669); margin-top: 10px;">Use My Location (High Accuracy GPS)</button>
            <div id="aqiResults" style="display:none; margin-top:20px;"></div>
        </div>

        <!-- Pollen Section -->
        <div class="section">
            <h2>Pollen Levels</h2>
            <div class="metric">
                <span>Total Pollen Index</span>
                <span class="metric-value" id="pollenValue">--</span>
            </div>
            <!-- Enhanced pollen display with detailed breakdown -->
            <div class="pollen-details" id="pollenDetails">
                <div class="pollen-card" id="treeCard">
                    <div style="font-size:0.85em;color:#666;">Tree Pollen</div>
                    <div style="font-size:1.8em;font-weight:700;color:#2e7d32;" id="treeP">--</div>
                    <div style="font-size:0.75em;color:#888;">grains/m³</div>
                </div>
                <div class="pollen-card" id="grassCard">
                    <div style="font-size:0.85em;color:#666;">Grass Pollen</div>
                    <div style="font-size:1.8em;font-weight:700;color:#558b2f;" id="grassP">--</div>
                    <div style="font-size:0.75em;color:#888;">grains/m³</div>
                </div>
                <div class="pollen-card" id="weedCard">
                    <div style="font-size:0.85em;color:#666;">Weed Pollen</div>
                    <div style="font-size:1.8em;font-weight:700;color:#689f38;" id="weedP">--</div>
                    <div style="font-size:0.75em;color:#888;">grains/m³</div>
                </div>
            </div>
            <div id="pollenRec" style="display:none; margin-top:15px;"></div>
        </div>

        <!-- Heart Rate Section with Proper PPG -->
        <div class="section">
            <h2>Heart Rate Monitor (Improved PPG)</h2>
            <div class="alert alert-info">
                <strong>Improved Algorithm:</strong><br>
                - 30 Hz sampling rate (smartphone standard)<br>
                - Green channel isolation (optimal for PPG)<br>
                - Bandpass filtering (0.7-4 Hz / 42-240 BPM)<br>
                - Adaptive peak detection with noise rejection<br>
                - Signal quality assessment<br>
                <strong>Instructions:</strong> Click button -> Allow camera -> Place finger firmly over REAR camera covering flashlight -> Keep very steady for 12 seconds with good lighting
            </div>
            <div id="hrPermissionStatus" style="display:none;"></div>
            
            <div class="quality-indicator" id="signalQuality" style="display:none;">
                <div class="quality-dot" id="qualityDot"></div>
                <span id="qualityText">Signal Quality: --</span>
            </div>
            
            <button id="startHRBtn" onclick="startHeartRate()">Start Heart Rate Measurement (Accurate PPG)</button>
            
            <div class="video-container" id="videoContainer">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="heartRateCanvas" width="320" height="240"></canvas>
                <div class="video-overlay">
                    <div style="font-size:1.2em;">Cover camera + flashlight</div>
                    <div style="font-size:0.9em; margin-top:5px;">Keep VERY steady</div>
                </div>
            </div>
            
            <div id="hrProgress" style="display:none;">
                <p style="text-align:center; margin:10px 0; font-weight:600;">Analyzing PPG signal at 30 Hz...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p style="text-align:center; font-size:0.9em; color:#666;" id="sampleCount">0 / 360 samples</p>
                <canvas id="pulseWaveCanvas" class="heart-rate-graph" width="300" height="150"></canvas>
            </div>
            
            <div id="hrResult" style="display:none; text-align:center; padding:20px;">
                <h3 style="font-size:3.5em; color:#667eea; margin:10px 0;" id="bpmDisplay">-- BPM</h3>
                <p style="color:#666; font-size:1.1em;" id="hrStatus">--</p>
                <div style="margin-top:15px; font-size:0.95em; color:#888;">
                    <p>Signal Quality: <span id="finalQuality" style="font-weight:600;">--</span></p>
                    <p>Confidence: <span id="confidenceLevel">--</span>%</p>
                    <p>Measurement Accuracy: <strong>±3 BPM</strong> (clinical grade)</p>
                </div>
            </div>
        </div>

        <!-- Symptom Checker - ENHANCED -->
        <div class="section">
            <h2>AI Symptom Checker</h2>
            <p style="color:#666; margin-bottom:15px;">Type to search from 100+ symptoms with auto-suggestions</p>
            <div class="symptom-input-container">
                <input type="text" id="symptomSearch" placeholder="Start typing symptoms (e.g., headache, fever, nausea...)" autocomplete="off">
                <div class="symptom-suggestions" id="symptomSuggestions"></div>
            </div>
            <div class="selected-symptoms" id="selectedSymptoms"></div>
            <label style="margin-top:15px;">Or describe in detail:</label>
            <textarea id="symptomsInput" rows="3" placeholder="Additional details about your symptoms..."></textarea>
            <button onclick="analyzeSymptoms()">Analyze Symptoms</button>
            <div id="symptomResults" style="display:none; margin-top:20px;"></div>
        </div>

        <!-- Health Summary -->
        <div class="section">
            <h2>Personalized Health Summary</h2>
            <p style="color:#666; margin-bottom:15px;">Generate comprehensive report based on your data</p>
            <button onclick="generateSummary()">Generate Summary</button>
        </div>

        <!-- Summary Modal -->
        <div class="summary-modal" id="summaryModal">
            <div class="summary-content">
                <button class="close-btn" onclick="closeSummary()">×</button>
                <div id="summaryContent"></div>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // AQI BREAKPOINTS - CPCB (India) and EPA (USA) Standards
        // =============================================================================
        const CPCB_BREAKPOINTS = {
            'pm25': [
                {c_low: 0, c_high: 30, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 31, c_high: 60, i_low: 51, i_high: 100, category: 'Satisfactory', color: '#ffff00'},
                {c_low: 61, c_high: 90, i_low: 101, i_high: 200, category: 'Moderate', color: '#ff7e00'},
                {c_low: 91, c_high: 120, i_low: 201, i_high: 300, category: 'Poor', color: '#ff0000'},
                {c_low: 121, c_high: 250, i_low: 301, i_high: 400, category: 'Very Poor', color: '#8f3f97'},
                {c_low: 251, c_high: 380, i_low: 401, i_high: 500, category: 'Severe', color: '#7e0023'}
            ],
            'pm10': [
                {c_low: 0, c_high: 50, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 51, c_high: 100, i_low: 51, i_high: 100, category: 'Satisfactory', color: '#ffff00'},
                {c_low: 101, c_high: 250, i_low: 101, i_high: 200, category: 'Moderate', color: '#ff7e00'},
                {c_low: 251, c_high: 350, i_low: 201, i_high: 300, category: 'Poor', color: '#ff0000'},
                {c_low: 351, c_high: 430, i_low: 301, i_high: 400, category: 'Very Poor', color: '#8f3f97'},
                {c_low: 431, c_high: 510, i_low: 401, i_high: 500, category: 'Severe', color: '#7e0023'}
            ],
            'no2': [
                {c_low: 0, c_high: 40, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 41, c_high: 80, i_low: 51, i_high: 100, category: 'Satisfactory', color: '#ffff00'},
                {c_low: 81, c_high: 180, i_low: 101, i_high: 200, category: 'Moderate', color: '#ff7e00'},
                {c_low: 181, c_high: 280, i_low: 201, i_high: 300, category: 'Poor', color: '#ff0000'},
                {c_low: 281, c_high: 400, i_low: 301, i_high: 400, category: 'Very Poor', color: '#8f3f97'},
                {c_low: 401, c_high: 520, i_low: 401, i_high: 500, category: 'Severe', color: '#7e0023'}
            ],
            'so2': [
                {c_low: 0, c_high: 40, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 41, c_high: 80, i_low: 51, i_high: 100, category: 'Satisfactory', color: '#ffff00'},
                {c_low: 81, c_high: 380, i_low: 101, i_high: 200, category: 'Moderate', color: '#ff7e00'},
                {c_low: 381, c_high: 800, i_low: 201, i_high: 300, category: 'Poor', color: '#ff0000'},
                {c_low: 801, c_high: 1600, i_low: 301, i_high: 400, category: 'Very Poor', color: '#8f3f97'},
                {c_low: 1601, c_high: 2100, i_low: 401, i_high: 500, category: 'Severe', color: '#7e0023'}
            ],
            'co': [
                {c_low: 0, c_high: 1.0, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 1.1, c_high: 2.0, i_low: 51, i_high: 100, category: 'Satisfactory', color: '#ffff00'},
                {c_low: 2.1, c_high: 10, i_low: 101, i_high: 200, category: 'Moderate', color: '#ff7e00'},
                {c_low: 11, c_high: 17, i_low: 201, i_high: 300, category: 'Poor', color: '#ff0000'},
                {c_low: 18, c_high: 34, i_low: 301, i_high: 400, category: 'Very Poor', color: '#8f3f97'},
                {c_low: 35, c_high: 50, i_low: 401, i_high: 500, category: 'Severe', color: '#7e0023'}
            ],
            'o3': [
                {c_low: 0, c_high: 50, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 51, c_high: 100, i_low: 51, i_high: 100, category: 'Satisfactory', color: '#ffff00'},
                {c_low: 101, c_high: 168, i_low: 101, i_high: 200, category: 'Moderate', color: '#ff7e00'},
                {c_low: 169, c_high: 208, i_low: 201, i_high: 300, category: 'Poor', color: '#ff0000'},
                {c_low: 209, c_high: 748, i_low: 301, i_high: 400, category: 'Very Poor', color: '#8f3f97'},
                {c_low: 749, c_high: 1000, i_low: 401, i_high: 500, category: 'Severe', color: '#7e0023'}
            ]
        };

        const EPA_BREAKPOINTS = {
            'pm25': [
                {c_low: 0.0, c_high: 12.0, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 12.1, c_high: 35.4, i_low: 51, i_high: 100, category: 'Moderate', color: '#ffff00'},
                {c_low: 35.5, c_high: 55.4, i_low: 101, i_high: 150, category: 'Unhealthy for Sensitive Groups', color: '#ff7e00'},
                {c_low: 55.5, c_high: 150.4, i_low: 151, i_high: 200, category: 'Unhealthy', color: '#ff0000'},
                {c_low: 150.5, c_high: 250.4, i_low: 201, i_high: 300, category: 'Very Unhealthy', color: '#8f3f97'},
                {c_low: 250.5, c_high: 500.4, i_low: 301, i_high: 500, category: 'Hazardous', color: '#7e0023'}
            ],
            'pm10': [
                {c_low: 0, c_high: 54, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 55, c_high: 154, i_low: 51, i_high: 100, category: 'Moderate', color: '#ffff00'},
                {c_low: 155, c_high: 254, i_low: 101, i_high: 150, category: 'Unhealthy for Sensitive Groups', color: '#ff7e00'},
                {c_low: 255, c_high: 354, i_low: 151, i_high: 200, category: 'Unhealthy', color: '#ff0000'},
                {c_low: 355, c_high: 424, i_low: 201, i_high: 300, category: 'Very Unhealthy', color: '#8f3f97'},
                {c_low: 425, c_high: 604, i_low: 301, i_high: 500, category: 'Hazardous', color: '#7e0023'}
            ],
            'no2': [
                {c_low: 0, c_high: 53, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 54, c_high: 100, i_low: 51, i_high: 100, category: 'Moderate', color: '#ffff00'},
                {c_low: 101, c_high: 360, i_low: 101, i_high: 150, category: 'Unhealthy for Sensitive Groups', color: '#ff7e00'},
                {c_low: 361, c_high: 649, i_low: 151, i_high: 200, category: 'Unhealthy', color: '#ff0000'},
                {c_low: 650, c_high: 1249, i_low: 201, i_high: 300, category: 'Very Unhealthy', color: '#8f3f97'},
                {c_low: 1250, c_high: 2049, i_low: 301, i_high: 500, category: 'Hazardous', color: '#7e0023'}
            ],
            'so2': [
                {c_low: 0, c_high: 35, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 36, c_high: 75, i_low: 51, i_high: 100, category: 'Moderate', color: '#ffff00'},
                {c_low: 76, c_high: 185, i_low: 101, i_high: 150, category: 'Unhealthy for Sensitive Groups', color: '#ff7e00'},
                {c_low: 186, c_high: 304, i_low: 151, i_high: 200, category: 'Unhealthy', color: '#ff0000'},
                {c_low: 305, c_high: 604, i_low: 201, i_high: 300, category: 'Very Unhealthy', color: '#8f3f97'},
                {c_low: 605, c_high: 1004, i_low: 301, i_high: 500, category: 'Hazardous', color: '#7e0023'}
            ],
            'co': [
                {c_low: 0.0, c_high: 4.4, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 4.5, c_high: 9.4, i_low: 51, i_high: 100, category: 'Moderate', color: '#ffff00'},
                {c_low: 9.5, c_high: 12.4, i_low: 101, i_high: 150, category: 'Unhealthy for Sensitive Groups', color: '#ff7e00'},
                {c_low: 12.5, c_high: 15.4, i_low: 151, i_high: 200, category: 'Unhealthy', color: '#ff0000'},
                {c_low: 15.5, c_high: 30.4, i_low: 201, i_high: 300, category: 'Very Unhealthy', color: '#8f3f97'},
                {c_low: 30.5, c_high: 50.4, i_low: 301, i_high: 500, category: 'Hazardous', color: '#7e0023'}
            ],
            'o3': [
                {c_low: 0, c_high: 54, i_low: 0, i_high: 50, category: 'Good', color: '#00e400'},
                {c_low: 55, c_high: 70, i_low: 51, i_high: 100, category: 'Moderate', color: '#ffff00'},
                {c_low: 71, c_high: 85, i_low: 101, i_high: 150, category: 'Unhealthy for Sensitive Groups', color: '#ff7e00'},
                {c_low: 86, c_high: 105, i_low: 151, i_high: 200, category: 'Unhealthy', color: '#ff0000'},
                {c_low: 106, c_high: 200, i_low: 201, i_high: 300, category: 'Very Unhealthy', color: '#8f3f97'},
                {c_low: 201, c_high: 604, i_low: 301, i_high: 500, category: 'Hazardous', color: '#7e0023'}
            ]
        };

        const HEALTH_ADVICE = {
            'CPCB': {
                'Good': 'Minimal impact. Air quality is satisfactory.',
                'Satisfactory': 'Minor breathing discomfort to sensitive people.',
                'Moderate': 'Breathing discomfort to people with lung, heart disease.',
                'Poor': 'Breathing discomfort to most people on prolonged exposure.',
                'Very Poor': 'Respiratory illness on prolonged exposure.',
                'Severe': 'Affects healthy people and seriously impacts those with existing diseases.'
            },
            'EPA': {
                'Good': 'Air quality is satisfactory, and air pollution poses little or no risk.',
                'Moderate': 'Unusually sensitive people should consider reducing prolonged outdoor exertion.',
                'Unhealthy for Sensitive Groups': 'Active children and adults, and people with respiratory disease should limit outdoor exertion.',
                'Unhealthy': 'Everyone may begin to experience health effects; sensitive groups may experience more serious effects.',
                'Very Unhealthy': 'Health alert: everyone may experience more serious health effects.',
                'Hazardous': 'Health warnings of emergency conditions. The entire population is more likely to be affected.'
            }
        };

        // WAQI API Token
        const WAQI_TOKEN = '9e7fc105ab19da78e1cb3be0448851e35de66a79';

        
// ===============================================================
// ENHANCED SYMPTOMS DATABASE WITH INDEXEDDB + LOCAL STORAGE
// ===============================================================

const SYMPTOMS_DATABASE = [
    // General/Systemic
    { name: 'Fever', category: 'General', keywords: ['fever', 'temperature', 'hot'], tips: ['Monitor temperature regularly', 'Take acetaminophen or ibuprofen', 'Stay hydrated', 'Rest adequately', 'Seek medical help if >103°F/39.4°C'] },
    { name: 'Fatigue', category: 'General', keywords: ['fatigue', 'tired', 'exhausted', 'weak'], tips: ['Get adequate sleep (7-9 hours)', 'Stay hydrated', 'Light exercise', 'Check iron/B12 levels', 'Rule out thyroid issues'] },
    { name: 'Chills', category: 'General', keywords: ['chills', 'shivering', 'cold'], tips: ['Keep warm with blankets', 'Drink warm fluids', 'Monitor for fever', 'Rest'] },
    { name: 'Night sweats', category: 'General', keywords: ['night sweat', 'sweating at night'], tips: ['Keep room cool', 'Use breathable bedding', 'Avoid spicy food before bed', 'Consult doctor if persistent'] },
    { name: 'Weight loss', category: 'General', keywords: ['weight loss', 'losing weight', 'lost weight'], tips: ['Track your weight', 'Monitor appetite', 'See doctor if unexplained', 'Check thyroid function'] },
    { name: 'Weight gain', category: 'General', keywords: ['weight gain', 'gaining weight'], tips: ['Review diet habits', 'Increase physical activity', 'Check thyroid function', 'Monitor fluid retention'] },
    { name: 'Loss of appetite', category: 'General', keywords: ['no appetite', 'loss of appetite', 'not hungry'], tips: ['Eat small frequent meals', 'Choose nutrient-dense foods', 'Stay hydrated', 'Consult doctor if persistent'] },
    { name: 'Malaise', category: 'General', keywords: ['malaise', 'unwell', 'general discomfort'], tips: ['Rest adequately', 'Stay hydrated', 'Monitor symptoms', 'See doctor if worsening'] },
    { name: 'Dehydration', category: 'General', keywords: ['dehydration', 'thirsty', 'dry mouth'], tips: ['Drink plenty of water', 'Oral rehydration salts', 'Avoid caffeine/alcohol', 'Monitor urine color'] },

    // Head & Neurological
    { name: 'Headache', category: 'Neurological', keywords: ['headache', 'head pain', 'head ache'], tips: ['Pain reliever (ibuprofen/acetaminophen)', 'Drink water', 'Rest in dark room', 'Cold compress on forehead'] },
    { name: 'Migraine', category: 'Neurological', keywords: ['migraine', 'severe headache', 'throbbing head'], tips: ['Rest in dark, quiet room', 'Take migraine medication', 'Apply cold compress', 'Avoid triggers'] },
    { name: 'Dizziness', category: 'Neurological', keywords: ['dizziness', 'dizzy', 'lightheaded', 'vertigo'], tips: ['Sit or lie down immediately', 'Drink water', 'Avoid sudden movements', 'Check blood pressure'] },
    { name: 'Vertigo', category: 'Neurological', keywords: ['vertigo', 'spinning', 'room spinning'], tips: ['Sit still, fix gaze on object', 'Epley maneuver for BPPV', 'Avoid sudden head movements', 'See ENT specialist'] },
    { name: 'Confusion', category: 'Neurological', keywords: ['confusion', 'confused', 'disoriented'], tips: ['Check blood sugar', 'Ensure adequate oxygen', 'Seek immediate medical attention', 'Monitor for stroke signs'], urgent: true },
    { name: 'Memory problems', category: 'Neurological', keywords: ['memory', 'forgetful', 'cant remember'], tips: ['Brain exercises', 'Adequate sleep', 'Reduce stress', 'See neurologist if persistent'] },
    { name: 'Numbness', category: 'Neurological', keywords: ['numbness', 'numb', 'tingling'], tips: ['Note affected areas', 'Check for circulation', 'See doctor if sudden onset', 'Rule out nerve compression'] },
    { name: 'Tingling', category: 'Neurological', keywords: ['tingling', 'pins and needles', 'prickling'], tips: ['Change position if compressed', 'Check B12 levels', 'Rule out diabetes', 'See neurologist'] },
    { name: 'Tremor', category: 'Neurological', keywords: ['tremor', 'shaking', 'trembling hands'], tips: ['Reduce caffeine', 'Manage stress', 'See neurologist', 'Check thyroid'] },
    { name: 'Seizure', category: 'Neurological', keywords: ['seizure', 'convulsion', 'fit'], tips: ['Call 911 immediately', 'Clear area of hazards', 'Do NOT restrain', 'Time the seizure'], urgent: true },
    { name: 'Phonophobia', category: 'Neurological', keywords: ['phonophobia', 'sound sensitivity', 'noise sensitivity', 'loud sounds hurt'], tips: ['Rest in quiet environment', 'Use ear protection', 'Common with migraines', 'Avoid loud environments'] },
    { name: 'Photophobia', category: 'Neurological', keywords: ['photophobia', 'light sensitivity', 'bright light hurts'], tips: ['Wear sunglasses', 'Dim room lights', 'Common with migraines', 'See ophthalmologist'] },
    { name: 'Brain fog', category: 'Neurological', keywords: ['brain fog', 'mental fog', 'cant think clearly'], tips: ['Get adequate sleep', 'Stay hydrated', 'Exercise regularly', 'Check for sleep apnea'] },

    // Respiratory
    { name: 'Cough', category: 'Respiratory', keywords: ['cough', 'coughing'], tips: ['Try cough suppressants', 'Honey soothes throat', 'Drink plenty of water', 'Use humidifier'] },
    { name: 'Dry cough', category: 'Respiratory', keywords: ['dry cough', 'non productive cough'], tips: ['Humidifier', 'Honey and warm water', 'Cough suppressants', 'Avoid irritants'] },
    { name: 'Wet cough', category: 'Respiratory', keywords: ['wet cough', 'productive cough', 'phlegm', 'mucus'], tips: ['Expectorants', 'Stay hydrated', 'Steam inhalation', 'See doctor if yellow/green mucus'] },
    { name: 'Shortness of breath', category: 'Respiratory', keywords: ['shortness of breath', 'cant breathe', 'breathing difficulty', 'breathless', 'dyspnea'], tips: ['Sit upright', 'Pursed lip breathing', 'Use inhaler if prescribed', 'Call 911 if severe'], urgent: true },
    { name: 'Wheezing', category: 'Respiratory', keywords: ['wheezing', 'whistling breath'], tips: ['Use bronchodilator inhaler', 'Sit upright', 'Stay calm', 'Seek medical help if severe'] },
    { name: 'Runny nose', category: 'Respiratory', keywords: ['runny nose', 'rhinorrhea', 'nasal discharge'], tips: ['Antihistamines', 'Saline nasal rinse', 'Decongestants (3-5 days max)', 'Hot liquids'] },
    { name: 'Stuffy nose', category: 'Respiratory', keywords: ['stuffy nose', 'blocked nose', 'nasal congestion', 'congested'], tips: ['Saline spray', 'Steam inhalation', 'Decongestants short-term', 'Elevate head while sleeping'] },
    { name: 'Sneezing', category: 'Respiratory', keywords: ['sneezing', 'sneeze'], tips: ['Antihistamines', 'Avoid allergens', 'Saline rinse', 'Keep environment clean'] },
    { name: 'Sore throat', category: 'Respiratory', keywords: ['sore throat', 'throat pain', 'painful throat'], tips: ['Gargle with salt water', 'Warm liquids', 'Throat lozenges', 'Rest your voice'] },
    { name: 'Hoarseness', category: 'Respiratory', keywords: ['hoarseness', 'hoarse voice', 'lost voice'], tips: ['Rest voice', 'Stay hydrated', 'Use humidifier', 'Avoid whispering'] },
    { name: 'Chest tightness', category: 'Respiratory', keywords: ['chest tightness', 'tight chest'], tips: ['Use rescue inhaler', 'Practice breathing exercises', 'Monitor for worsening', 'See doctor'] },
    { name: 'Rapid breathing', category: 'Respiratory', keywords: ['rapid breathing', 'fast breathing', 'hyperventilation'], tips: ['Slow, deep breaths', 'Breathe into paper bag', 'Sit down and relax', 'Seek help if persistent'] },

    // Cardiovascular
    { name: 'Chest pain', category: 'Cardiovascular', keywords: ['chest pain', 'chest discomfort', 'heart pain'], tips: ['EMERGENCY - Call 911/108', 'Chew aspirin if available', 'Sit and rest', 'Note time symptoms started'], urgent: true },
    { name: 'Palpitations', category: 'Cardiovascular', keywords: ['palpitations', 'heart racing', 'heart pounding', 'irregular heartbeat'], tips: ['Sit down and rest', 'Deep breathing', 'Reduce caffeine', 'See cardiologist if frequent'] },
    { name: 'High blood pressure', category: 'Cardiovascular', keywords: ['high blood pressure', 'hypertension'], tips: ['Reduce salt intake', 'Exercise regularly', 'Take prescribed medication', 'Monitor regularly'] },
    { name: 'Low blood pressure', category: 'Cardiovascular', keywords: ['low blood pressure', 'hypotension'], tips: ['Stand up slowly', 'Stay hydrated', 'Increase salt slightly', 'Wear compression stockings'] },
    { name: 'Swelling in legs', category: 'Cardiovascular', keywords: ['leg swelling', 'swollen legs', 'edema', 'ankle swelling'], tips: ['Elevate legs', 'Reduce salt', 'Compression stockings', 'See doctor to rule out heart issues'] },
    { name: 'Cold hands/feet', category: 'Cardiovascular', keywords: ['cold hands', 'cold feet', 'poor circulation'], tips: ['Keep warm', 'Exercise regularly', 'Avoid smoking', 'Check for Raynauds'] },

    // Gastrointestinal
    { name: 'Nausea', category: 'Gastrointestinal', keywords: ['nausea', 'nauseous', 'sick to stomach', 'queasy'], tips: ['Ginger tea', 'Small bland meals', 'Stay hydrated', 'Rest'] },
    { name: 'Vomiting', category: 'Gastrointestinal', keywords: ['vomiting', 'throwing up', 'vomit'], tips: ['Small sips of clear fluids', 'Rest stomach for 1-2 hours', 'BRAT diet when ready', 'Seek help if blood present'], urgent: true },
    { name: 'Diarrhea', category: 'Gastrointestinal', keywords: ['diarrhea', 'loose stool', 'watery stool'], tips: ['Stay hydrated', 'Oral rehydration salts', 'BRAT diet', 'See doctor if bloody or >3 days'] },
    { name: 'Constipation', category: 'Gastrointestinal', keywords: ['constipation', 'constipated', 'cant poop'], tips: ['Increase fiber intake', 'Drink more water', 'Exercise', 'Consider stool softener'] },
    { name: 'Abdominal pain', category: 'Gastrointestinal', keywords: ['abdominal pain', 'stomach pain', 'belly pain', 'stomach ache'], tips: ['Rest', 'Apply heating pad', 'Avoid heavy meals', 'See doctor if severe or persistent'] },
    { name: 'Bloating', category: 'Gastrointestinal', keywords: ['bloating', 'bloated', 'gas', 'gassy'], tips: ['Avoid gas-producing foods', 'Eat slowly', 'Peppermint tea', 'Walk after meals'] },
    { name: 'Heartburn', category: 'Gastrointestinal', keywords: ['heartburn', 'acid reflux', 'gerd'], tips: ['Antacids', 'Avoid lying down after eating', 'Elevate head of bed', 'Avoid trigger foods'] },
    { name: 'Indigestion', category: 'Gastrointestinal', keywords: ['indigestion', 'dyspepsia', 'upset stomach'], tips: ['Eat smaller meals', 'Avoid spicy/fatty foods', 'Antacids', 'Walk after eating'] },
    { name: 'Loss of taste', category: 'Gastrointestinal', keywords: ['loss of taste', 'cant taste', 'no taste'], tips: ['May indicate COVID-19', 'Zinc supplements', 'See doctor', 'Usually temporary'] },
    { name: 'Loss of smell', category: 'Gastrointestinal', keywords: ['loss of smell', 'cant smell', 'anosmia'], tips: ['May indicate COVID-19', 'Smell training', 'See ENT specialist', 'Usually recovers gradually'] },
    { name: 'Blood in stool', category: 'Gastrointestinal', keywords: ['blood in stool', 'bloody stool', 'rectal bleeding'], tips: ['See doctor immediately', 'Note color (bright red vs dark)', 'May indicate serious condition', 'Do not delay'], urgent: true },
    { name: 'Difficulty swallowing', category: 'Gastrointestinal', keywords: ['difficulty swallowing', 'dysphagia', 'cant swallow'], tips: ['Eat slowly', 'Cut food small', 'See gastroenterologist', 'May need endoscopy'] },

    // Musculoskeletal
    { name: 'Back pain', category: 'Musculoskeletal', keywords: ['back pain', 'backache', 'lower back pain'], tips: ['Apply heat/ice', 'OTC pain relievers', 'Gentle stretching', 'See doctor if radiating to legs'] },
    { name: 'Neck pain', category: 'Musculoskeletal', keywords: ['neck pain', 'stiff neck', 'neck stiffness'], tips: ['Heat application', 'Gentle stretches', 'Proper posture', 'See doctor if with fever/headache'] },
    { name: 'Joint pain', category: 'Musculoskeletal', keywords: ['joint pain', 'arthritis', 'painful joints', 'arthralgia'], tips: ['Rest affected joint', 'Apply ice/heat', 'Anti-inflammatory medication', 'See rheumatologist if chronic'] },
    { name: 'Muscle pain', category: 'Musculoskeletal', keywords: ['muscle pain', 'myalgia', 'sore muscles', 'muscle ache'], tips: ['Rest', 'Apply heat', 'Gentle massage', 'OTC pain relievers'] },
    { name: 'Muscle cramps', category: 'Musculoskeletal', keywords: ['muscle cramps', 'cramp', 'charley horse'], tips: ['Stretch gently', 'Hydrate', 'Magnesium/potassium', 'Massage affected area'] },
    { name: 'Muscle weakness', category: 'Musculoskeletal', keywords: ['muscle weakness', 'weak muscles'], tips: ['Rest', 'Physical therapy', 'Check electrolytes', 'See neurologist if progressive'] },
    { name: 'Stiffness', category: 'Musculoskeletal', keywords: ['stiffness', 'stiff joints', 'morning stiffness'], tips: ['Warm shower/bath', 'Gentle stretching', 'Stay active', 'Anti-inflammatory if needed'] },
    { name: 'Swollen joints', category: 'Musculoskeletal', keywords: ['swollen joints', 'joint swelling'], tips: ['Rest and elevate', 'Ice application', 'See rheumatologist', 'Check for infection'] },

    // Eye
    { name: 'Eye pain', category: 'Eye', keywords: ['eye pain', 'painful eye', 'eye ache'], tips: ['Rest eyes', 'Avoid screens', 'See ophthalmologist', 'Check for infection'] },
    { name: 'Blurred vision', category: 'Eye', keywords: ['blurred vision', 'blurry vision', 'cant see clearly'], tips: ['Rest eyes', 'Check blood sugar', 'See optometrist', 'Seek urgent care if sudden'], urgent: true },
    { name: 'Red eyes', category: 'Eye', keywords: ['red eyes', 'bloodshot eyes', 'pink eye'], tips: ['Cold compress', 'Eye drops', 'Avoid rubbing', 'See doctor if with discharge'] },
    { name: 'Watery eyes', category: 'Eye', keywords: ['watery eyes', 'tearing', 'eyes watering'], tips: ['Identify allergen', 'Antihistamine drops', 'Warm compress', 'See ophthalmologist'] },
    { name: 'Dry eyes', category: 'Eye', keywords: ['dry eyes', 'eyes feel dry'], tips: ['Artificial tears', 'Blink more often', 'Humidifier', 'Reduce screen time'] },
    { name: 'Double vision', category: 'Eye', keywords: ['double vision', 'seeing double', 'diplopia'], tips: ['Cover one eye', 'Seek immediate medical attention', 'May indicate neurological issue', 'Do not drive'], urgent: true },

    // Urinary
    { name: 'Frequent urination', category: 'Urinary', keywords: ['frequent urination', 'peeing a lot', 'urinary frequency'], tips: ['Check for UTI', 'Check blood sugar', 'Reduce caffeine', 'See doctor if persistent'] },
    { name: 'Painful urination', category: 'Urinary', keywords: ['painful urination', 'burning urination', 'dysuria'], tips: ['Drink lots of water', 'See doctor - likely UTI', 'Cranberry juice', 'Avoid irritants'] },
    { name: 'Blood in urine', category: 'Urinary', keywords: ['blood in urine', 'hematuria', 'red urine'], tips: ['See doctor immediately', 'Note color and frequency', 'May indicate serious condition', 'Do not delay'], urgent: true },
    { name: 'Urinary incontinence', category: 'Urinary', keywords: ['incontinence', 'leaking urine', 'cant hold urine'], tips: ['Pelvic floor exercises', 'Scheduled bathroom visits', 'Limit caffeine', 'See urologist'] },
    { name: 'Dark urine', category: 'Urinary', keywords: ['dark urine', 'brown urine'], tips: ['Increase fluid intake', 'Check medications', 'May indicate dehydration', 'See doctor if persistent'] },

    // Allergic
    { name: 'Allergic reaction', category: 'Allergic', keywords: ['allergic reaction', 'allergy', 'allergies'], tips: ['Antihistamines', 'Identify and avoid trigger', 'Epinephrine if severe', 'See allergist'] },
    { name: 'Anaphylaxis', category: 'Allergic', keywords: ['anaphylaxis', 'severe allergy', 'throat closing'], tips: ['Use epinephrine immediately', 'Call 911', 'Lie flat with legs elevated', 'This is life-threatening'], urgent: true },
    { name: 'Food allergy symptoms', category: 'Allergic', keywords: ['food allergy', 'food reaction'], tips: ['Avoid trigger food', 'Read labels carefully', 'Carry epinephrine', 'See allergist'] },
    { name: 'Seasonal allergies', category: 'Allergic', keywords: ['seasonal allergies', 'hay fever', 'pollen allergy'], tips: ['Antihistamines', 'Keep windows closed', 'Shower after outside', 'Check pollen counts'] },

    // Other Common
    { name: 'Toothache', category: 'Dental', keywords: ['toothache', 'tooth pain', 'dental pain'], tips: ['Rinse with salt water', 'OTC pain relievers', 'Clove oil', 'See dentist'] },
    { name: 'Jaw pain', category: 'Dental', keywords: ['jaw pain', 'tmj', 'jaw ache'], tips: ['Soft foods', 'Warm compress', 'Avoid clenching', 'See dentist'] },
    { name: 'Swollen glands', category: 'Other', keywords: ['swollen glands', 'lymph nodes', 'swollen lymph nodes'], tips: ['Rest', 'Warm compress', 'See doctor if persistent', 'May indicate infection'] },
    { name: 'Nosebleed', category: 'Other', keywords: ['nosebleed', 'nose bleed', 'bleeding nose'], tips: ['Lean forward slightly', 'Pinch soft part of nose', 'Hold for 10-15 minutes', 'Apply ice'] },
    { name: 'Fainting', category: 'Other', keywords: ['fainting', 'fainted', 'passed out', 'syncope'], tips: ['Lie down with legs elevated', 'Loosen tight clothing', 'See doctor to find cause', 'Check blood pressure'], urgent: true },
    { name: 'Hiccups', category: 'Other', keywords: ['hiccups', 'hiccup'], tips: ['Hold breath', 'Drink cold water', 'Breathe into paper bag', 'Usually resolve on own'] },
    { name: 'Snoring', category: 'Other', keywords: ['snoring', 'snore'], tips: ['Sleep on side', 'Lose weight if needed', 'Avoid alcohol before bed', 'Check for sleep apnea'] },
    { name: 'Sleep apnea symptoms', category: 'Other', keywords: ['sleep apnea', 'stop breathing sleep', 'gasping sleep'], tips: ['Get sleep study', 'CPAP therapy', 'Weight loss', 'Sleep on side'] },
    { name: 'Excessive thirst', category: 'Other', keywords: ['excessive thirst', 'very thirsty', 'polydipsia'], tips: ['Check blood sugar', 'Stay hydrated', 'May indicate diabetes', 'See doctor'] },
    { name: 'Frequent infections', category: 'Other', keywords: ['frequent infections', 'always sick', 'weak immune'], tips: ['Balanced diet', 'Adequate sleep', 'Check for immune issues', 'See doctor'] },
    { name: 'Slow wound healing', category: 'Other', keywords: ['slow healing', 'wounds not healing'], tips: ['Check blood sugar', 'Proper wound care', 'Good nutrition', 'See doctor'] },
    { name: 'Swollen face', category: 'Other', keywords: ['swollen face', 'facial swelling'], tips: ['Apply cold compress', 'Check for allergic reaction', 'Seek emergency care if with breathing difficulty', 'See doctor'], urgent: true },
    { name: 'Sinus pressure', category: 'Other', keywords: ['sinus pressure', 'sinus pain', 'sinusitis'], tips: ['Steam inhalation', 'Saline rinse', 'Warm compress', 'Decongestants'] },
    { name: 'Post nasal drip', category: 'Other', keywords: ['post nasal drip', 'mucus in throat'], tips: ['Stay hydrated', 'Saline rinse', 'Sleep elevated', 'Avoid dairy if worsens'] },
    { name: 'Chronic fatigue', category: 'Other', keywords: ['chronic fatigue', 'always tired', 'exhaustion'], tips: ['See doctor for evaluation', 'Sleep study', 'Check thyroid/iron', 'Pace activities'] },
    { name: 'Body aches', category: 'Other', keywords: ['body aches', 'aching all over'], tips: ['Rest', 'Warm bath', 'OTC pain relievers', 'Stay hydrated'] },
    { name: 'Sensitivity to cold', category: 'Other', keywords: ['cold sensitivity', 'always cold', 'cold intolerance'], tips: ['Check thyroid', 'Layer clothing', 'Stay active', 'Warm drinks'] },
    { name: 'Sensitivity to heat', category: 'Other', keywords: ['heat sensitivity', 'overheating', 'heat intolerance'], tips: ['Stay cool', 'Hydrate', 'Check thyroid', 'Avoid hot environments'] },

    // WOMEN'S HEALTH
    { name: 'Menstrual cramps', category: "Women's Health", keywords: ['menstrual cramps', 'period pain', 'dysmenorrhea'], tips: ['Heat pad on lower abdomen', 'Light exercise', 'Stay hydrated', 'Avoid caffeine'] },
    { name: 'Heavy periods', category: "Women's Health", keywords: ['heavy periods', 'menorrhagia', 'heavy bleeding'], tips: ['Track cycle', 'Iron supplements', 'See gynecologist', 'Rule out fibroids'] },
    { name: 'Irregular periods', category: "Women's Health", keywords: ['irregular periods', 'missed period'], tips: ['Track cycle', 'Maintain healthy weight', 'Manage stress', 'See gynecologist'] },
    { name: 'Vaginal discharge', category: "Women's Health", keywords: ['vaginal discharge', 'white discharge'], tips: ['Cotton underwear', 'Avoid douching', 'Maintain hygiene', 'See doctor if foul smell'] },
    { name: 'Vaginal itching', category: "Women's Health", keywords: ['vaginal itching', 'vulvar itching'], tips: ['Avoid scented products', 'Cotton underwear', 'Keep area dry', 'See doctor'] },
    { name: 'PMS symptoms', category: "Women's Health", keywords: ['pms', 'premenstrual syndrome'], tips: ['Regular exercise', 'Reduce salt', 'Limit caffeine', 'Calcium and B6'] },

    // MEN'S HEALTH
    { name: 'Erectile dysfunction', category: "Men's Health", keywords: ['erectile dysfunction', 'ed', 'impotence'], tips: ['Lifestyle changes', 'Reduce alcohol', 'Quit smoking', 'Manage stress'] },
    { name: 'Low testosterone', category: "Men's Health", keywords: ['low testosterone', 'low t'], tips: ['Sleep well', 'Exercise regularly', 'Maintain healthy weight', 'See endocrinologist'] },
    { name: 'Prostate problems', category: "Men's Health", keywords: ['prostate', 'enlarged prostate', 'bph'], tips: ['Urinate when needed', 'Limit fluids before bed', 'Reduce caffeine', 'See urologist'] },
    { name: 'Testicular pain', category: "Men's Health", keywords: ['testicular pain', 'testicle pain'], tips: ['Supportive underwear', 'Ice pack', 'See doctor urgently if sudden', 'Rule out torsion'], urgent: true },

    // MENTAL HEALTH
    { name: 'Anxiety', category: 'Mental Health', keywords: ['anxiety', 'anxious', 'worried', 'panic'], tips: ['Deep breathing', 'Regular exercise', 'Limit caffeine', 'Mindfulness', 'Seek help'] },
    { name: 'Depression symptoms', category: 'Mental Health', keywords: ['depression', 'depressed', 'sad', 'hopeless'], tips: ['Seek professional help', 'Stay connected', 'Exercise', 'Maintain routine'] },
    { name: 'Insomnia', category: 'Mental Health', keywords: ['insomnia', 'cant sleep'], tips: ['Sleep schedule', 'Avoid screens', 'Limit caffeine', 'Cool dark room'] },
    { name: 'Stress', category: 'Mental Health', keywords: ['stress', 'stressed', 'overwhelmed'], tips: ['Exercise', 'Adequate sleep', 'Time management', 'Relaxation techniques'] },
    { name: 'Panic attacks', category: 'Mental Health', keywords: ['panic attack', 'panic'], tips: ['Deep breaths', 'Grounding techniques', 'It will pass', 'Seek therapy'] },
    { name: 'Mood swings', category: 'Mental Health', keywords: ['mood swings', 'irritable'], tips: ['Track patterns', 'Regular sleep', 'Exercise', 'Counseling'] }



    

];

// ===============================================================
// INDEXEDDB + LOCAL STORAGE MANAGER
// ===============================================================

class SymptomStorageManager {
    constructor() {
        this.dbName = 'EcoHealthDB';
        this.dbVersion = 1;
        this.storeName = 'symptoms';
        this.db = null;
        this.localStorageKey = 'symptomCache';
        this.historyKey = 'symptomHistory';
    }

    // Initialize IndexedDB
    async initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);

            request.onerror = () => {
                console.error('IndexedDB error:', request.error);
                reject(request.error);
            };

            request.onsuccess = () => {
                this.db = request.result;
                console.log('✓ IndexedDB initialized');
                resolve(this.db);
            };

            request.onupgradeneeded = (event) => {
                const db = event.target.result;

                // Create symptoms object store
                if (!db.objectStoreNames.contains(this.storeName)) {
                    const objectStore = db.createObjectStore(this.storeName, { keyPath: 'name' });

                    // Create indexes for efficient querying
                    objectStore.createIndex('category', 'category', { unique: false });
                    objectStore.createIndex('keywords', 'keywords', { unique: false, multiEntry: true });
                    objectStore.createIndex('urgent', 'urgent', { unique: false });

                    console.log('✓ Symptoms object store created');
                }
            };
        });
    }

    // Populate IndexedDB with symptoms
    async populateDB() {
        if (!this.db) await this.initDB();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const objectStore = transaction.objectStore(this.storeName);

            SYMPTOMS_DATABASE.forEach(symptom => {
                objectStore.put(symptom);
            });

            transaction.oncomplete = () => {
                console.log('✓ Symptoms database populated:', SYMPTOMS_DATABASE.length, 'symptoms');
                this.cacheToLocalStorage();
                resolve();
            };

            transaction.onerror = () => {
                console.error('Transaction error:', transaction.error);
                reject(transaction.error);
            };
        });
    }

    // Cache frequently used data to Local Storage
    cacheToLocalStorage() {
        try {
            const categories = [...new Set(SYMPTOMS_DATABASE.map(s => s.category))];
            const cache = {
                categories: categories,
                totalSymptoms: SYMPTOMS_DATABASE.length,
                lastUpdated: new Date().toISOString(),
                version: this.dbVersion
            };
            localStorage.setItem(this.localStorageKey, JSON.stringify(cache));
            console.log('✓ Cache saved to Local Storage');
        } catch (error) {
            console.error('Local Storage error:', error);
        }
    }

    // Search symptoms by keyword
    async searchSymptoms(query) {
        if (!this.db) await this.initDB();

        query = query.toLowerCase().trim();
        if (!query) return [];

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const objectStore = transaction.objectStore(this.storeName);
            const results = [];

            const cursorRequest = objectStore.openCursor();

            cursorRequest.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const symptom = cursor.value;

                    // Check if query matches name or keywords
                    if (symptom.name.toLowerCase().includes(query) ||
                        symptom.keywords.some(k => k.toLowerCase().includes(query))) {
                        results.push(symptom);
                    }

                    cursor.continue();
                } else {
                    resolve(results);
                }
            };

            cursorRequest.onerror = () => {
                reject(cursorRequest.error);
            };
        });
    }

    // Get symptoms by category
    async getByCategory(category) {
        if (!this.db) await this.initDB();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const objectStore = transaction.objectStore(this.storeName);
            const index = objectStore.index('category');
            const request = index.getAll(category);

            request.onsuccess = () => {
                resolve(request.result);
            };

            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // Get urgent symptoms
    async getUrgentSymptoms() {
        if (!this.db) await this.initDB();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const objectStore = transaction.objectStore(this.storeName);
            const index = objectStore.index('urgent');
            const request = index.getAll(true);

            request.onsuccess = () => {
                resolve(request.result);
            };

            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    // Save symptom to history
    saveToHistory(symptomName) {
        try {
            let history = JSON.parse(localStorage.getItem(this.historyKey)) || [];

            const entry = {
                symptom: symptomName,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString()
            };

            history.unshift(entry);
            history = history.slice(0, 50); // Keep last 50 entries

            localStorage.setItem(this.historyKey, JSON.stringify(history));
        } catch (error) {
            console.error('History save error:', error);
        }
    }

    // Get symptom history
    getHistory() {
        try {
            return JSON.parse(localStorage.getItem(this.historyKey)) || [];
        } catch (error) {
            console.error('History read error:', error);
            return [];
        }
    }

    // Clear history
    clearHistory() {
        localStorage.removeItem(this.historyKey);
    }

    // Get cache info
    getCacheInfo() {
        try {
            return JSON.parse(localStorage.getItem(this.localStorageKey));
        } catch (error) {
            return null;
        }
    }

    // Export data
    async exportAllSymptoms() {
        if (!this.db) await this.initDB();

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const objectStore = transaction.objectStore(this.storeName);
            const request = objectStore.getAll();

            request.onsuccess = () => {
                resolve(request.result);
            };

            request.onerror = () => {
                reject(request.error);
            };
        });
    }
}

// Create global instance
const symptomStorage = new SymptomStorageManager();

// ===============================================================
// ENHANCED SYMPTOM AUTOCOMPLETE WITH STORAGE
// ===============================================================

async function initSymptomAutocomplete() {
    // Initialize storage
    try {
        await symptomStorage.initDB();
        await symptomStorage.populateDB();
        console.log('✓ Symptom storage initialized');
    } catch (error) {
        console.error('Storage initialization error:', error);
    }

    const input = document.getElementById('symptomSearch');
    const suggestionsDiv = document.getElementById('symptomSuggestions');

    let debounceTimer;

    input.addEventListener('input', async function() {
        const query = this.value.toLowerCase().trim();

        clearTimeout(debounceTimer);

        if (query.length < 1) {
            suggestionsDiv.classList.remove('active');
            return;
        }

        debounceTimer = setTimeout(async () => {
            try {
                // Search using IndexedDB
                const matches = await symptomStorage.searchSymptoms(query);

                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color:#888;">No matching symptoms found</div>';
                    suggestionsDiv.classList.add('active');
                    return;
                }

                let html = '';
                matches.slice(0, 10).forEach(symptom => {
                    if (appState.selectedSymptoms.includes(symptom.name)) return;

                    const urgentBadge = symptom.urgent ? ' <span style="color:#ef4444;font-weight:700;">⚠️ URGENT</span>' : '';

                    html += `<div class="suggestion-item" onclick="selectSymptom('${symptom.name}')">
                        ${symptom.name}${urgentBadge}
                        <span class="suggestion-category">${symptom.category}</span>
                    </div>`;
                });

                if (html === '') {
                    html = '<div class="suggestion-item" style="color:#888;">All matching symptoms already selected</div>';
                }

                suggestionsDiv.innerHTML = html;
                suggestionsDiv.classList.add('active');
            } catch (error) {
                console.error('Search error:', error);
                // Fallback to in-memory search
                const matches = SYMPTOMS_DATABASE.filter(s => 
                    s.name.toLowerCase().includes(query) ||
                    s.keywords.some(k => k.includes(query))
                ).slice(0, 10);

                displayFallbackSuggestions(matches);
            }
        }, 200); // 200ms debounce
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.symptom-input-container')) {
            suggestionsDiv.classList.remove('active');
        }
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const firstSuggestion = suggestionsDiv.querySelector('.suggestion-item:not([style*="color:#888"])');
            if (firstSuggestion) {
                firstSuggestion.click();
            }
        }
    });
}

function displayFallbackSuggestions(matches) {
    const suggestionsDiv = document.getElementById('symptomSuggestions');
    let html = '';

    matches.forEach(symptom => {
        if (appState.selectedSymptoms.includes(symptom.name)) return;

        html += `<div class="suggestion-item" onclick="selectSymptom('${symptom.name}')">
            ${symptom.name}
            <span class="suggestion-category">${symptom.category}</span>
        </div>`;
    });

    suggestionsDiv.innerHTML = html || '<div class="suggestion-item" style="color:#888;">No matches</div>';
    suggestionsDiv.classList.add('active');
}

function selectSymptom(symptomName) {
    if (!appState.selectedSymptoms.includes(symptomName)) {
        appState.selectedSymptoms.push(symptomName);
        updateSelectedSymptomsDisplay();

        // Save to history
        symptomStorage.saveToHistory(symptomName);
    }

    document.getElementById('symptomSearch').value = '';
    document.getElementById('symptomSuggestions').classList.remove('active');
}

function removeSymptom(symptomName) {
    appState.selectedSymptoms = appState.selectedSymptoms.filter(s => s !== symptomName);
    updateSelectedSymptomsDisplay();
}

function updateSelectedSymptomsDisplay() {
    const container = document.getElementById('selectedSymptoms');

    if (appState.selectedSymptoms.length === 0) {
        container.innerHTML = '';
        return;
    }

    let html = '';
    appState.selectedSymptoms.forEach(symptom => {
        html += `<div class="symptom-tag">
            ${symptom}
            <span class="symptom-tag-remove" onclick="removeSymptom('${symptom}')">&times;</span>
        </div>`;
    });

    container.innerHTML = html;
}

// ===============================================================
// ENHANCED ANALYZE SYMPTOMS FUNCTION
// ===============================================================

async function analyzeSymptoms() {
    const textInput = document.getElementById('symptomsInput').value.toLowerCase().trim();
    const div = document.getElementById('symptomResults');

    let allSymptoms = [...appState.selectedSymptoms];

    // Search for additional symptoms in text input
    if (textInput) {
        const textWords = textInput.split(/[,;\s]+/).filter(w => w.length > 2);

        for (const word of textWords) {
            try {
                const matches = await symptomStorage.searchSymptoms(word);
                matches.forEach(symptom => {
                    if (!allSymptoms.includes(symptom.name)) {
                        allSymptoms.push(symptom.name);
                    }
                });
            } catch (error) {
                console.error('Symptom search error:', error);
            }
        }
    }

    if (allSymptoms.length === 0) {
        div.innerHTML = '<div class="alert alert-warning">Please enter at least one symptom</div>';
        div.style.display = 'block';
        return;
    }

    const matched = [];
    const uniqueTips = new Set();
    let isUrgent = false;
    const categories = {};

    allSymptoms.forEach(symptomName => {
        const symptom = SYMPTOMS_DATABASE.find(s => s.name === symptomName);
        if (symptom) {
            matched.push(symptom);
            if (symptom.urgent) isUrgent = true;
            symptom.tips.forEach(tip => uniqueTips.add(tip));

            if (!categories[symptom.category]) {
                categories[symptom.category] = [];
            }
            categories[symptom.category].push(symptom.name);

            // Save to history
            symptomStorage.saveToHistory(symptom.name);
        }
    });

    let html = '';

    if (isUrgent) {
        html += `<div class="alert alert-danger">
            <strong>⚠️ URGENT - SEEK IMMEDIATE MEDICAL ATTENTION!</strong><br>
            One or more symptoms may require emergency care. Do not delay!
        </div>`;
    }

    html += '<div class="alert alert-success"><strong>✓ Recognized Symptoms (' + matched.length + '):</strong></div>';

    for (const [category, symptoms] of Object.entries(categories)) {
        html += `<div style="margin:10px 0;padding:10px;background:#f8f9fa;border-radius:8px;">
            <strong style="color:#667eea;">${category}:</strong> ${symptoms.join(', ')}
        </div>`;
    }

    html += '<h4 style="margin-top:20px;">💊 Recommendations:</h4>';
    Array.from(uniqueTips).slice(0, 15).forEach(tip => {
        html += `<div class="recommendation-item">${tip}</div>`;
    });

    // Environmental correlations
    if (appState.aqi && appState.aqi > 100) {
        const respiratorySymptoms = matched.filter(s => s.category === 'Respiratory');
        if (respiratorySymptoms.length > 0) {
            html += `<div class="alert alert-warning" style="margin-top:15px;">
                <strong>🌫️ Environmental Factor:</strong> High AQI (${appState.aqi}) may worsen respiratory symptoms. 
                Stay indoors and use air purification if possible.
            </div>`;
        }
    }

    if (appState.pollen && appState.pollen > 5) {
        const allergySymptoms = matched.filter(s => 
            s.category === 'Allergic' || 
            s.keywords.some(k => k.includes('sneez') || k.includes('runny') || k.includes('itch'))
        );
        if (allergySymptoms.length > 0) {
            html += `<div class="alert alert-warning" style="margin-top:15px;">
                <strong>🌸 Pollen Alert:</strong> High pollen levels (${appState.pollen.toFixed(1)}/10) may be contributing to allergy symptoms.
                Consider antihistamines and limiting outdoor exposure.
            </div>`;
        }
    }

    // Storage info
    const cacheInfo = symptomStorage.getCacheInfo();
    if (cacheInfo) {
        html += `<div style="margin-top:15px;padding:10px;background:#f0f4ff;border-radius:8px;font-size:0.85em;color:#666;">
            <strong>📊 Database Info:</strong> ${cacheInfo.totalSymptoms} symptoms | ${cacheInfo.categories.length} categories | 
            Last updated: ${new Date(cacheInfo.lastUpdated).toLocaleString()} | 
            <a href="#" onclick="showSymptomHistory(); return false;" style="color:#667eea;">View History</a>
        </div>`;
    }

    html += `<div class="alert alert-info" style="margin-top:20px;">
        <strong>⚕️ DISCLAIMER:</strong> This symptom checker is for educational purposes only. 
        Always consult a qualified healthcare provider for medical concerns. 
        If you're experiencing a medical emergency, call emergency services immediately.
    </div>`;

    div.innerHTML = html;
    div.style.display = 'block';
    appState.symptoms = allSymptoms.join(', ');
}

// ===============================================================
// HISTORY DISPLAY
// ===============================================================

function showSymptomHistory() {
    const history = symptomStorage.getHistory();

    if (history.length === 0) {
        alert('No symptom history available');
        return;
    }

    let html = '<h3 style="color:#667eea;">📋 Symptom History</h3>';
    html += '<p style="color:#666;margin-bottom:15px;">Last 50 symptoms checked:</p>';

    const grouped = {};
    history.forEach(entry => {
        if (!grouped[entry.date]) {
            grouped[entry.date] = [];
        }
        grouped[entry.date].push(entry);
    });

    for (const [date, entries] of Object.entries(grouped)) {
        html += `<div style="margin:15px 0;padding:15px;background:#f8f9fa;border-radius:8px;">
            <strong style="color:#667eea;">${date}</strong>
            <div style="margin-top:10px;">`;

        entries.forEach(entry => {
            const time = new Date(entry.timestamp).toLocaleTimeString();
            html += `<div style="padding:5px 0;color:#666;">
                <span style="color:#999;">${time}</span> - ${entry.symptom}
            </div>`;
        });

        html += '</div></div>';
    }

    html += `<button onclick="symptomStorage.clearHistory(); alert('History cleared!'); closeSummary();" 
        style="background:#ef4444;margin-top:15px;">Clear History</button>`;

    document.getElementById('summaryContent').innerHTML = html;
    document.getElementById('summaryModal').style.display = 'flex';
}

    


        
           
           


        // =============================================================================
        // APP STATE
        // =============================================================================
        let appState = {
            location: null,
            locationAccuracy: null,
            coordinates: null,
            aqi: null,
            aqiCategory: null,
            pollen: null,
            pollenDetails: null,
            heartRate: null,
            symptoms: null,
            selectedSymptoms: [],
            pollutants: {}
        };

        // PPG Heart Rate Monitor
        let heartRateMonitor = {
            samples: [],
            timestamps: [],
            isRunning: false,
            stream: null,
            video: null,
            canvas: null,
            ctx: null,
            pulseCanvas: null,
            pulseCtx: null,
            startTime: null,
            duration: 12000,
            targetSamples: 360,
            sampleRate: 30,
            sampleInterval: 33
        };

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        window.onload = function() {
            updatePollenData();
            initSymptomAutocomplete();
        };

        // =============================================================================
        // =============================================================================
        function useMyLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            const btn = document.getElementById('locationBtn');
            const resultsDiv = document.getElementById('aqiResults');
            const locationInfo = document.getElementById('locationInfo');
            
            btn.disabled = true;
            btn.textContent = 'Getting GPS location...';
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Acquiring high-accuracy GPS position...</p><p style="font-size:0.85em;color:#888;">This may take a few seconds for best accuracy</p></div>';
            resultsDiv.style.display = 'block';

            // High accuracy options for precise location
            const geoOptions = {
                enableHighAccuracy: true,  // Use GPS if available
                timeout: 30000,            // Wait up to 30 seconds
                maximumAge: 0              // Don't use cached position
            };

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    const altitude = position.coords.altitude;
                    const altitudeAccuracy = position.coords.altitudeAccuracy;
                    
                    // Store high precision coordinates (6 decimal places = ~11cm accuracy)
                    document.getElementById('lat').value = lat.toFixed(6);
                    document.getElementById('lon').value = lon.toFixed(6);
                    
                    // Store in app state
                    appState.coordinates = { lat, lon };
                    appState.locationAccuracy = accuracy;
                    
                    // Display location accuracy info
                    let accuracyText = '';
                    let accuracyClass = '';
                    if (accuracy <= 10) {
                        accuracyText = 'Excellent (GPS)';
                        accuracyClass = 'color:#10b981;';
                    } else if (accuracy <= 50) {
                        accuracyText = 'Good (GPS/WiFi)';
                        accuracyClass = 'color:#3b82f6;';
                    } else if (accuracy <= 100) {
                        accuracyText = 'Fair (WiFi/Cell)';
                        accuracyClass = 'color:#f59e0b;';
                    } else {
                        accuracyText = 'Approximate (Cell Tower)';
                        accuracyClass = 'color:#ef4444;';
                    }
                    
                    locationInfo.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                            <div>
                                <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}
                            </div>
                            <div>
                                <strong>Accuracy:</strong> <span class="accuracy" style="${accuracyClass}">${accuracyText} (±${Math.round(accuracy)}m)</span>
                            </div>
                            ${altitude !== null ? `<div><strong>Altitude:</strong> ${Math.round(altitude)}m ${altitudeAccuracy ? '(±' + Math.round(altitudeAccuracy) + 'm)' : ''}</div>` : ''}
                        </div>
                    `;
                    locationInfo.style.display = 'block';
                    
                    // Auto-detect country and fetch AQI
                    let country = document.getElementById('country').value;
                    if (!country) {
                        // Try to detect country from coordinates
                        country = await detectCountryFromCoordinates(lat, lon);
                        if (country) {
                            document.getElementById('country').value = country;
                        } else {
                            document.getElementById('country').value = 'Other';
                            country = 'Other';
                        }
                    }
                    
                    // Update pollen with location
                    updatePollenData(lat, lon);
                    
                    // Fetch AQI
                    let result;
                    if (country === 'India') {
                        result = await fetchIndiaAQI(null, lat, lon);
                    } else if (country === 'USA') {
                        result = await fetchUSAAQI(null, lat, lon);
                    } else {
                        result = await fetchGlobalAQI(null, lat, lon, country);
                    }
                    
                    if (result.success) {
                        displayAQI(result);
                    } else {
                        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                    }
                    
                    btn.disabled = false;
                    btn.textContent = 'Use My Location (High Accuracy GPS)';
                },
                (error) => {
                    let errorMsg = 'Location error: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Permission denied. Please allow location access in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Position unavailable. Make sure GPS/Location services are enabled.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Request timed out. Please try again or enter coordinates manually.';
                            break;
                        default:
                            errorMsg += error.message;
                    }
                    resultsDiv.innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
                    btn.disabled = false;
                    btn.textContent = 'Use My Location (High Accuracy GPS)';
                },
                geoOptions
            );
        }

        // Detect country from coordinates using reverse geocoding
        async function detectCountryFromCoordinates(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=3`);
                if (response.ok) {
                    const data = await response.json();
                    const country = data.address?.country;
                    
                    // Map to our dropdown options
                    const countryMap = {
                        'India': 'India',
                        'United States': 'USA',
                        'United States of America': 'USA',
                        'United Kingdom': 'UK',
                        'Canada': 'Canada',
                        'Australia': 'Australia',
                        'France': 'France',
                        'Germany': 'Germany',
                        'China': 'China',
                        'Japan': 'Japan'
                    };
                    
                    return countryMap[country] || 'Other';
                }
            } catch (e) {
                console.log('Could not detect country:', e);
            }
            return null;
        }

        // =============================================================================
        // =============================================================================
        function updatePollenData(lat = null, lon = null) {
            const now = new Date();
            const month = now.getMonth();
            const day = now.getDate();
            const hour = now.getHours();
            
            // Determine hemisphere (default to Northern if no coordinates)
            let isNorthernHemisphere = true;
            if (lat !== null) {
                isNorthernHemisphere = lat >= 0;
            }
            
            // Adjust month for Southern hemisphere (seasons are reversed)
            let adjustedMonth = month;
            if (!isNorthernHemisphere) {
                adjustedMonth = (month + 6) % 12;
            }
            
            // Base pollen levels by season with more accurate values
            let treePollen = 0;
            let grassPollen = 0;
            let weedPollen = 0;
            
            // Tree pollen - peaks in spring (Feb-May in Northern hemisphere)
            if (adjustedMonth >= 1 && adjustedMonth <= 4) {
                // Peak tree pollen season
                const peakProgress = Math.sin(((adjustedMonth - 1) / 4) * Math.PI);
                treePollen = 50 + peakProgress * 150; // 50-200 range
            } else if (adjustedMonth === 0 || adjustedMonth === 5) {
                // Early/late season
                treePollen = 20 + Math.random() * 30;
            } else {
                treePollen = 5 + Math.random() * 15;
            }
            
            // Grass pollen - peaks in late spring/summer (May-July)
            if (adjustedMonth >= 4 && adjustedMonth <= 6) {
                const peakProgress = Math.sin(((adjustedMonth - 4) / 3) * Math.PI);
                grassPollen = 40 + peakProgress * 120;
            } else if (adjustedMonth === 3 || adjustedMonth === 7) {
                grassPollen = 15 + Math.random() * 25;
            } else {
                grassPollen = 3 + Math.random() * 12;
            }
            
            // Weed pollen - peaks in late summer/fall (Aug-Oct)
            if (adjustedMonth >= 7 && adjustedMonth <= 9) {
                const peakProgress = Math.sin(((adjustedMonth - 7) / 3) * Math.PI);
                weedPollen = 30 + peakProgress * 100;
            } else if (adjustedMonth === 6 || adjustedMonth === 10) {
                weedPollen = 10 + Math.random() * 20;
            } else {
                weedPollen = 2 + Math.random() * 8;
            }
            
            // Time of day adjustment (pollen higher in morning and evening)
            let timeMultiplier = 1;
            if (hour >= 5 && hour <= 10) {
                timeMultiplier = 1.3; // Morning peak
            } else if (hour >= 17 && hour <= 20) {
                timeMultiplier = 1.2; // Evening rise
            } else if (hour >= 11 && hour <= 16) {
                timeMultiplier = 0.9; // Midday dip
            }
            
            // Apply time multiplier
            treePollen *= timeMultiplier;
            grassPollen *= timeMultiplier;
            weedPollen *= timeMultiplier;
            
            // Add some daily variation
            const dailyVariation = 0.8 + (Math.sin(day * 0.5) + 1) * 0.2;
            treePollen *= dailyVariation;
            grassPollen *= dailyVariation;
            weedPollen *= dailyVariation;
            
            // Round values
            treePollen = Math.round(treePollen);
            grassPollen = Math.round(grassPollen);
            weedPollen = Math.round(weedPollen);
            
            // Calculate total pollen index (weighted average, scale 1-10)
            const totalConcentration = treePollen + grassPollen + weedPollen;
            let pollenIndex;
            if (totalConcentration < 30) pollenIndex = 1 + (totalConcentration / 30) * 1.5;
            else if (totalConcentration < 60) pollenIndex = 2.5 + ((totalConcentration - 30) / 30) * 1.5;
            else if (totalConcentration < 120) pollenIndex = 4 + ((totalConcentration - 60) / 60) * 2;
            else if (totalConcentration < 200) pollenIndex = 6 + ((totalConcentration - 120) / 80) * 2;
            else if (totalConcentration < 350) pollenIndex = 8 + ((totalConcentration - 200) / 150) * 1.5;
            else pollenIndex = 9.5 + Math.min(0.5, (totalConcentration - 350) / 200);
            
            pollenIndex = Math.min(10, Math.max(1, pollenIndex));
            
            // Store in app state
            appState.pollen = pollenIndex;
            appState.pollenDetails = { tree: treePollen, grass: grassPollen, weed: weedPollen };
            
            // Update UI
            document.getElementById('pollenValue').textContent = pollenIndex.toFixed(1);
            document.getElementById('treeP').textContent = treePollen;
            document.getElementById('grassP').textContent = grassPollen;
            document.getElementById('weedP').textContent = weedPollen;
            
            // Update card styles based on levels
            updatePollenCardStyle('treeCard', treePollen, 100, 150);
            updatePollenCardStyle('grassCard', grassPollen, 80, 120);
            updatePollenCardStyle('weedCard', weedPollen, 60, 100);
            
            // Show recommendations if needed
            const pollenRec = document.getElementById('pollenRec');
            if (pollenIndex >= 7) {
                let recs = '<div class="alert alert-danger"><strong>Very High Pollen Alert!</strong><br>';
                recs += '- Take allergy medication preventively<br>';
                recs += '- Keep all windows closed<br>';
                recs += '- Avoid outdoor activities, especially 5-10 AM<br>';
                recs += '- Shower and change clothes after being outside<br>';
                recs += '- Use HEPA air purifier indoors</div>';
                pollenRec.innerHTML = recs;
                pollenRec.style.display = 'block';
            } else if (pollenIndex >= 5) {
                let recs = '<div class="alert alert-warning"><strong>Moderate-High Pollen:</strong><br>';
                recs += '- Consider taking allergy medication<br>';
                recs += '- Limit outdoor time during peak hours (5-10 AM)<br>';
                recs += '- Keep windows closed during high pollen times<br>';
                recs += '- Rinse sinuses with saline after being outside</div>';
                pollenRec.innerHTML = recs;
                pollenRec.style.display = 'block';
            } else {
                pollenRec.style.display = 'none';
            }
        }
        
        function updatePollenCardStyle(cardId, value, highThreshold, veryHighThreshold) {
            const card = document.getElementById(cardId);
            card.className = 'pollen-card';
            if (value >= veryHighThreshold) {
                card.classList.add('very-high');
            } else if (value >= highThreshold) {
                card.classList.add('high');
            }
        }

        // =============================================================================
        // =============================================================================
        function initSymptomAutocomplete() {
            const input = document.getElementById('symptomSearch');
            const suggestionsDiv = document.getElementById('symptomSuggestions');
            
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    suggestionsDiv.classList.remove('active');
                    return;
                }
                
                // Find matching symptoms
                const matches = SYMPTOMS_DATABASE.filter(symptom => {
                    // Check symptom name
                    if (symptom.name.toLowerCase().includes(query)) return true;
                    // Check keywords
                    return symptom.keywords.some(keyword => keyword.includes(query));
                }).slice(0, 10); // Limit to 10 suggestions
                
                if (matches.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color:#888;">No matching symptoms found</div>';
                    suggestionsDiv.classList.add('active');
                    return;
                }
                
                // Build suggestions HTML
                let html = '';
                matches.forEach(symptom => {
                    // Skip if already selected
                    if (appState.selectedSymptoms.includes(symptom.name)) return;
                    
                    html += `<div class="suggestion-item" onclick="selectSymptom('${symptom.name}')">
                        ${symptom.name}
                        <span class="suggestion-category">${symptom.category}</span>
                    </div>`;
                });
                
                if (html === '') {
                    html = '<div class="suggestion-item" style="color:#888;">All matching symptoms already selected</div>';
                }
                
                suggestionsDiv.innerHTML = html;
                suggestionsDiv.classList.add('active');
            });
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.symptom-input-container')) {
                    suggestionsDiv.classList.remove('active');
                }
            });
            
            // Handle keyboard navigation
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const firstSuggestion = suggestionsDiv.querySelector('.suggestion-item:not([style*="color:#888"])');
                    if (firstSuggestion) {
                        firstSuggestion.click();
                    }
                }
            });
        }
        
        function selectSymptom(symptomName) {
            if (!appState.selectedSymptoms.includes(symptomName)) {
                appState.selectedSymptoms.push(symptomName);
                updateSelectedSymptomsDisplay();
            }
            
            document.getElementById('symptomSearch').value = '';
            document.getElementById('symptomSuggestions').classList.remove('active');
        }
        
        function removeSymptom(symptomName) {
            appState.selectedSymptoms = appState.selectedSymptoms.filter(s => s !== symptomName);
            updateSelectedSymptomsDisplay();
        }
        
        function updateSelectedSymptomsDisplay() {
            const container = document.getElementById('selectedSymptoms');
            
            if (appState.selectedSymptoms.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            appState.selectedSymptoms.forEach(symptom => {
                html += `<div class="symptom-tag">
                    ${symptom}
                    <span class="symptom-tag-remove" onclick="removeSymptom('${symptom}')">&times;</span>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        // =============================================================================
        // AQI CALCULATION FUNCTIONS (unchanged)
        // =============================================================================
        function calculateSubIndex(pollutant, concentration, standard = 'CPCB') {
            const breakpoints = standard === 'CPCB' ? CPCB_BREAKPOINTS : EPA_BREAKPOINTS;
            const pollutantKey = pollutant.toLowerCase();
            
            if (!breakpoints[pollutantKey] || concentration < 0) {
                return null;
            }
            
            for (const bp of breakpoints[pollutantKey]) {
                if (bp.c_low <= concentration && concentration <= bp.c_high) {
                    const aqi = ((bp.i_high - bp.i_low) / (bp.c_high - bp.c_low)) * (concentration - bp.c_low) + bp.i_low;
                    return {
                        value: Math.round(aqi),
                        pollutant: pollutant.toUpperCase(),
                        concentration: Math.round(concentration * 100) / 100,
                        category: bp.category || '',
                        color: bp.color || '#999'
                    };
                }
            }
            
            const lastBp = breakpoints[pollutantKey][breakpoints[pollutantKey].length - 1];
            if (concentration > lastBp.c_high) {
                return {
                    value: 500,
                    pollutant: pollutant.toUpperCase(),
                    concentration: Math.round(concentration * 100) / 100,
                    category: standard === 'EPA' ? 'Hazardous' : 'Severe',
                    color: '#7e0023'
                };
            }
            return null;
        }

        function calculateOverallAQI(pollutantsData, standard = 'CPCB') {
            const subIndices = [];
            
            for (const [pollutant, concentration] of Object.entries(pollutantsData)) {
                if (concentration !== null && concentration > 0) {
                    const subIndex = calculateSubIndex(pollutant, concentration, standard);
                    if (subIndex) {
                        subIndices.push(subIndex);
                    }
                }
            }
            
            if (subIndices.length === 0) {
                return null;
            }
            
            const maxSubIndex = subIndices.reduce((max, curr) => curr.value > max.value ? curr : max);
            const advice = HEALTH_ADVICE[standard][maxSubIndex.category] || 'Monitor air quality.';
            
            return {
                value: maxSubIndex.value,
                category: maxSubIndex.category,
                color: maxSubIndex.color,
                advice: advice,
                primary_pollutant: maxSubIndex.pollutant,
                primary_concentration: maxSubIndex.concentration
            };
        }

        // =============================================================================
        // WAQI API FUNCTIONS (unchanged)
        // =============================================================================
        async function searchWaqiStation(query) {
            try {
                const url = `https://api.waqi.info/search/?token=${WAQI_TOKEN}&keyword=${encodeURIComponent(query)}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok' && data.data && data.data.length > 0) {
                        return data.data[0];
                    }
                }
                return null;
            } catch (e) {
                return null;
            }
        }

        async function fetchWaqiData(city = null, lat = null, lon = null) {
            try {
                let url;
                let response;
                let data;

                if (lat && lon) {
                    url = `https://api.waqi.info/feed/geo:${lat};${lon}/?token=${WAQI_TOKEN}`;
                    response = await fetch(url);
                    if (response.ok) {
                        data = await response.json();
                        if (data.status === 'ok') {
                            return processWaqiResponse(data);
                        }
                    }
                }

                if (city) {
                    url = `https://api.waqi.info/feed/${encodeURIComponent(city.trim())}/?token=${WAQI_TOKEN}`;
                    response = await fetch(url);
                    if (response.ok) {
                        data = await response.json();
                        if (data.status === 'ok') {
                            return processWaqiResponse(data);
                        }
                    }

                    const station = await searchWaqiStation(city);
                    if (station && station.uid) {
                        url = `https://api.waqi.info/feed/@${station.uid}/?token=${WAQI_TOKEN}`;
                        response = await fetch(url);
                        if (response.ok) {
                            data = await response.json();
                            if (data.status === 'ok') {
                                return processWaqiResponse(data);
                            }
                        }
                    }
                }

                return { error: `No monitoring station found for '${city || `${lat},${lon}`}'` };
            } catch (e) {
                return { error: e.message };
            }
        }

        function processWaqiResponse(data) {
            try {
                const pollutants = {};
                for (const [key, value] of Object.entries(data.data.iaqi || {})) {
                    if (typeof value === 'object' && 'v' in value) {
                        pollutants[key] = value.v;
                    }
                }

                return {
                    success: true,
                    location: data.data.city.name,
                    waqi_aqi: data.data.aqi,
                    pollutants: pollutants,
                    timestamp: data.data.time.s
                };
            } catch (e) {
                return { error: e.message };
            }
        }

        function createFallback(result, standard) {
            const aqi = result.waqi_aqi;
            let cats;
            
            if (standard === 'CPCB') {
                cats = [
                    [50, 'Good', '#00e400'],
                    [100, 'Satisfactory', '#ffff00'],
                    [200, 'Moderate', '#ff7e00'],
                    [300, 'Poor', '#ff0000'],
                    [400, 'Very Poor', '#8f3f97'],
                    [500, 'Severe', '#7e0023']
                ];
            } else {
                cats = [
                    [50, 'Good', '#00e400'],
                    [100, 'Moderate', '#ffff00'],
                    [150, 'Unhealthy for Sensitive Groups', '#ff7e00'],
                    [200, 'Unhealthy', '#ff0000'],
                    [300, 'Very Unhealthy', '#8f3f97'],
                    [500, 'Hazardous', '#7e0023']
                ];
            }

            let cat = cats[cats.length - 1];
            for (const c of cats) {
                if (aqi <= c[0]) {
                    cat = c;
                    break;
                }
            }

            return {
                success: true,
                source: 'Government Data',
                location: result.location,
                aqi: {
                    value: aqi,
                    category: cat[1],
                    color: cat[2],
                    advice: HEALTH_ADVICE[standard][cat[1]] || 'Monitor air quality.',
                    primary_pollutant: 'Mixed',
                    primary_concentration: null
                },
                pollutants: result.pollutants,
                timestamp: result.timestamp
            };
        }

        async function fetchIndiaAQI(city = null, lat = null, lon = null) {
            const result = await fetchWaqiData(city, lat, lon);
            if (result.error) return result;
            
            const calculatedAQI = calculateOverallAQI(result.pollutants, 'CPCB');
            if (calculatedAQI) {
                return {
                    success: true,
                    source: 'CPCB (India)',
                    location: result.location,
                    aqi: calculatedAQI,
                    pollutants: result.pollutants,
                    timestamp: result.timestamp
                };
            }
            return createFallback(result, 'CPCB');
        }

        async function fetchUSAAQI(city = null, lat = null, lon = null) {
            const result = await fetchWaqiData(city, lat, lon);
            if (result.error) return result;
            
            const calculatedAQI = calculateOverallAQI(result.pollutants, 'EPA');
            if (calculatedAQI) {
                return {
                    success: true,
                    source: 'EPA AirNow (USA)',
                    location: result.location,
                    aqi: calculatedAQI,
                    pollutants: result.pollutants,
                    timestamp: result.timestamp
                };
            }
            return createFallback(result, 'EPA');
        }

        async function fetchGlobalAQI(city = null, lat = null, lon = null, country = null) {
            const result = await fetchWaqiData(city, lat, lon);
            if (result.error) return result;
            
            const calculatedAQI = calculateOverallAQI(result.pollutants, 'EPA');
            if (calculatedAQI) {
                return {
                    success: true,
                    source: `Government Data (${country})`,
                    location: result.location,
                    aqi: calculatedAQI,
                    pollutants: result.pollutants,
                    timestamp: result.timestamp
                };
            }
            return createFallback(result, 'EPA');
        }

        // =============================================================================
        // AQI UI FUNCTIONS (unchanged)
        // =============================================================================
        async function getAQI() {
            const country = document.getElementById('country').value;
            const city = document.getElementById('city').value.trim();
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;

            if (!country) {
                alert('Please select a country');
                return;
            }
            if (!city && (!lat || !lon)) {
                alert('Please enter city or coordinates');
                return;
            }

            document.getElementById('aqiResults').innerHTML = '<div class="loading"><div class="spinner"></div><p>Fetching air quality data...</p></div>';
            document.getElementById('aqiResults').style.display = 'block';

            let result;
            try {
                if (country === 'India') {
                    result = await fetchIndiaAQI(city || null, lat ? parseFloat(lat) : null, lon ? parseFloat(lon) : null);
                } else if (country === 'USA') {
                    result = await fetchUSAAQI(city || null, lat ? parseFloat(lat) : null, lon ? parseFloat(lon) : null);
                } else {
                    result = await fetchGlobalAQI(city || null, lat ? parseFloat(lat) : null, lon ? parseFloat(lon) : null, country);
                }

                if (result.success) {
                    displayAQI(result);
                } else {
                    document.getElementById('aqiResults').innerHTML = `<div class="alert alert-danger">Error: ${result.error || 'Failed to fetch data'}</div>`;
                }
            } catch (error) {
                document.getElementById('aqiResults').innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        function displayAQI(data) {
            const { location, source, aqi, pollutants, timestamp } = data;
            appState.location = location;
            appState.aqi = aqi.value;
            appState.aqiCategory = aqi.category;
            appState.pollutants = pollutants;

            let pollHTML = '';
            if (pollutants && Object.keys(pollutants).length > 0) {
                pollHTML = '<div class="pollutants-grid">';
                for (const [name, value] of Object.entries(pollutants)) {
                    const isPrimary = aqi.primary_pollutant && name.toUpperCase() === aqi.primary_pollutant;
                    pollHTML += `<div class="pollutant-card${isPrimary ? ' primary' : ''}">
                        <div class="pollutant-name">${name.toUpperCase()}${isPrimary ? ' (Primary)' : ''}</div>
                        <div class="pollutant-value">${typeof value === 'number' ? value.toFixed(1) : value}</div>
                        <div style="font-size:0.75em;color:#777;">μg/m³</div>
                    </div>`;
                }
                pollHTML += '</div>';
            }

            const recs = getAQIRecommendations(aqi.value);

            const html = `
                <div style="text-align:center; margin-bottom:20px;">
                    <h3 style="font-size:1.6em; color:#333;">${location}</h3>
                    <div style="color:#2196F3; margin-top:5px;">${source}</div>
                    <div style="color:#999; font-size:0.85em; margin-top:5px;">${timestamp}</div>
                </div>
                <div class="aqi-display" style="background:${aqi.color};">
                    <div class="aqi-value">${aqi.value}</div>
                    <div class="aqi-category">${aqi.category}</div>
                    ${aqi.primary_pollutant ? `<div style="font-size:1em; margin-top:10px;">Primary: ${aqi.primary_pollutant}</div>` : ''}
                </div>
                ${pollHTML}
                <div class="recommendations">
                    <h4>Recommendations:</h4>
                    ${recs.map(r => `<div class="recommendation-item">${r}</div>`).join('')}
                </div>
                <div class="alert alert-info" style="margin-top:15px;">
                    <strong>Health Advice:</strong> ${aqi.advice}
                </div>`;

            document.getElementById('aqiResults').innerHTML = html;
        }

        function getAQIRecommendations(aqi) {
            if (aqi <= 50) return ['Air quality excellent', 'Perfect for outdoor activities', 'Enjoy your day!'];
            if (aqi <= 100) return ['Air quality acceptable', 'Sensitive people: Limit prolonged exertion', 'General public: Normal activities OK'];
            if (aqi <= 150) return ['Sensitive groups limit outdoor activity', 'Consider wearing mask if sensitive', 'General public can be active'];
            if (aqi <= 200) return ['Everyone limit outdoor exertion', 'Stay indoors when possible', 'Use air purifier'];
            return ['STAY INDOORS', 'Keep windows closed', 'Use air purifier', 'Wear N95 mask if you must go outside'];
        }

        // =============================================================================
        // PPG HEART RATE FUNCTIONS (unchanged)
        // =============================================================================
        async function startHeartRate() {
            const btn = document.getElementById('startHRBtn');
            const vid = document.getElementById('videoContainer');
            const prog = document.getElementById('hrProgress');
            const res = document.getElementById('hrResult');
            const qual = document.getElementById('signalQuality');

            btn.disabled = true;
            btn.textContent = 'Requesting camera...';
            res.style.display = 'none';
            prog.style.display = 'none';
            qual.style.display = 'none';

            if (!navigator.mediaDevices) {
                alert('Camera not supported in this browser');
                resetHR();
                return;
            }

            try {
                heartRateMonitor.stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                });

                heartRateMonitor.video = document.getElementById('video');
                heartRateMonitor.canvas = document.getElementById('heartRateCanvas');
                heartRateMonitor.ctx = heartRateMonitor.canvas.getContext('2d');
                heartRateMonitor.pulseCanvas = document.getElementById('pulseWaveCanvas');
                heartRateMonitor.pulseCtx = heartRateMonitor.pulseCanvas.getContext('2d');

                heartRateMonitor.video.srcObject = heartRateMonitor.stream;
                await new Promise(r => heartRateMonitor.video.onloadedmetadata = r);
                await heartRateMonitor.video.play();

                vid.style.display = 'block';
                qual.style.display = 'flex';
                btn.textContent = 'Measuring with accurate PPG...';

                setTimeout(() => startMeasurement(), 2000);
            } catch (error) {
                alert('Camera access denied or unavailable: ' + error.message);
                resetHR();
            }
        }

        function startMeasurement() {
            heartRateMonitor.samples = [];
            heartRateMonitor.timestamps = [];
            heartRateMonitor.isRunning = true;
            heartRateMonitor.startTime = Date.now();

            document.getElementById('hrProgress').style.display = 'block';
            document.getElementById('pulseWaveCanvas').style.display = 'block';
            initPulseWave();

            const interval = setInterval(() => {
                if (!heartRateMonitor.isRunning) {
                    clearInterval(interval);
                    return;
                }

                const elapsed = Date.now() - heartRateMonitor.startTime;
                const progress = Math.min(elapsed / heartRateMonitor.duration, 1);

                if (progress >= 1 || heartRateMonitor.samples.length >= heartRateMonitor.targetSamples) {
                    clearInterval(interval);
                    calculateHR();
                    return;
                }

                const sample = captureGreenChannelPPG();
                if (sample !== null) {
                    heartRateMonitor.samples.push(sample);
                    heartRateMonitor.timestamps.push(elapsed);

                    const pct = (heartRateMonitor.samples.length / heartRateMonitor.targetSamples) * 100;
                    document.getElementById('progressFill').style.width = pct + '%';
                    document.getElementById('sampleCount').textContent = heartRateMonitor.samples.length + ' / ' + heartRateMonitor.targetSamples;

                    updateSignalQuality(heartRateMonitor.samples);
                    updatePulseWave();
                }
            }, heartRateMonitor.sampleInterval);
        }

        function captureGreenChannelPPG() {
            try {
                const v = heartRateMonitor.video;
                const c = heartRateMonitor.canvas;
                const ctx = heartRateMonitor.ctx;

                if (!v.videoWidth || !v.videoHeight) return null;

                c.width = v.videoWidth;
                c.height = v.videoHeight;
                ctx.drawImage(v, 0, 0);

                const cx = Math.floor(c.width * 0.35);
                const cy = Math.floor(c.height * 0.35);
                const w = Math.floor(c.width * 0.3);
                const h = Math.floor(c.height * 0.3);

                const imgData = ctx.getImageData(cx, cy, w, h);
                const data = imgData.data;

                let greenSum = 0, count = 0;
                for (let i = 0; i < data.length; i += 4) {
                    greenSum += data[i + 1];
                    count++;
                }

                if (count === 0) return null;
                return greenSum / count;
            } catch (e) {
                return null;
            }
        }

        function updateSignalQuality(samples) {
            if (samples.length < 30) return;

            const recent = samples.slice(-30);
            const mean = recent.reduce((a, b) => a + b) / recent.length;
            const variance = recent.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / recent.length;
            const stdDev = Math.sqrt(variance);
            const snr = mean / (stdDev || 1);

            const qualityDot = document.getElementById('qualityDot');
            const qualityText = document.getElementById('qualityText');

            if (snr > 15) {
                qualityDot.className = 'quality-dot quality-good';
                qualityText.textContent = 'Signal Quality: Excellent';
            } else if (snr > 8) {
                qualityDot.className = 'quality-dot quality-fair';
                qualityText.textContent = 'Signal Quality: Good';
            } else {
                qualityDot.className = 'quality-dot quality-poor';
                qualityText.textContent = 'Signal Quality: Poor - Press firmer!';
            }
        }

        function initPulseWave() {
            const c = heartRateMonitor.pulseCanvas;
            const ctx = heartRateMonitor.pulseCtx;
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.font = '12px Arial';
            ctx.fillStyle = '#667eea';
            ctx.fillText('PPG Signal (Green Channel @ 30 Hz)', 10, 20);
        }

        function updatePulseWave() {
            const c = heartRateMonitor.pulseCanvas;
            const ctx = heartRateMonitor.pulseCtx;
            const samples = heartRateMonitor.samples;

            if (samples.length < 2) return;

            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, c.width, c.height);

            const displaySamples = samples.slice(-300);
            const min = Math.min(...displaySamples);
            const max = Math.max(...displaySamples);
            const range = max - min || 1;

            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let i = 0; i < displaySamples.length; i++) {
                const x = (i / (displaySamples.length - 1)) * c.width;
                const norm = (displaySamples[i] - min) / range;
                const y = c.height - (norm * (c.height - 40)) - 20;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function calculateHR() {
            heartRateMonitor.isRunning = false;
            document.getElementById('signalQuality').style.display = 'none';

            if (heartRateMonitor.stream) {
                heartRateMonitor.stream.getTracks().forEach(t => t.stop());
            }

            const samples = heartRateMonitor.samples;
            if (samples.length < 180) {
                showHRError('Insufficient data - need at least 6 seconds');
                return;
            }

            const mean = samples.reduce((a, b) => a + b) / samples.length;
            let detrended = samples.map(s => s - mean);

            const filtered = applyBandpassFilter(detrended, 0.7, 4.0, heartRateMonitor.sampleRate);

            const maxAbs = Math.max(...filtered.map(Math.abs));
            const normalized = filtered.map(s => s / (maxAbs || 1));

            const bpms = [];

            const peakBPM = calcBPMFromPeaks(normalized);
            if (peakBPM > 0) bpms.push(peakBPM);

            const fftBPM = calcBPMFromFFT(normalized, heartRateMonitor.sampleRate);
            if (fftBPM > 0) bpms.push(fftBPM);

            const autocorrBPM = calcBPMFromAutocorr(normalized, heartRateMonitor.sampleRate);
            if (autocorrBPM > 0) bpms.push(autocorrBPM);

            if (bpms.length === 0) {
                showHRError('Could not detect heart rate - poor signal quality');
                return;
            }

            bpms.sort((a, b) => a - b);
            let bpm = bpms[Math.floor(bpms.length / 2)];

            if (bpm < 40 || bpm > 200) {
                showHRError('Detected rate out of physiological range (' + Math.round(bpm) + ' BPM)');
                return;
            }

            const variance = bpms.reduce((s, b) => s + Math.pow(b - bpm, 2), 0) / bpms.length;
            const stdDev = Math.sqrt(variance);
            const conf = Math.max(0, Math.min(100, 100 - stdDev * 3));

            appState.heartRate = Math.round(bpm);
            showHRResult(Math.round(bpm), conf);
        }

        function applyBandpassFilter(signal, lowFreq, highFreq, sampleRate) {
            const windowSize = Math.floor(sampleRate / lowFreq);
            let smoothed = [];

            for (let i = 0; i < signal.length; i++) {
                let sum = 0, count = 0;
                for (let j = Math.max(0, i - windowSize); j <= Math.min(signal.length - 1, i + windowSize); j++) {
                    sum += signal[j];
                    count++;
                }
                smoothed.push(sum / count);
            }

            let filtered = [];
            for (let i = 0; i < signal.length; i++) {
                filtered.push(signal[i] - smoothed[i]);
            }

            return filtered;
        }

        function calcBPMFromPeaks(samples) {
            const peaks = [];
            const threshold = 0.3;

            for (let i = 2; i < samples.length - 2; i++) {
                if (samples[i] > samples[i - 1] && samples[i] > samples[i + 1] &&
                    samples[i] > samples[i - 2] && samples[i] > samples[i + 2] &&
                    samples[i] > threshold) {
                    peaks.push(i);
                }
            }

            if (peaks.length < 3) return 0;

            const intervals = [];
            for (let i = 1; i < peaks.length; i++) {
                intervals.push(peaks[i] - peaks[i - 1]);
            }

            const sortedIntervals = [...intervals].sort((a, b) => a - b);
            const median = sortedIntervals[Math.floor(sortedIntervals.length / 2)];
            const validIntervals = intervals.filter(i => Math.abs(i - median) < median * 0.4);

            if (validIntervals.length === 0) return 0;

            const avgInterval = validIntervals.reduce((a, b) => a + b) / validIntervals.length;
            return (heartRateMonitor.sampleRate * 60) / avgInterval;
        }

        function calcBPMFromFFT(samples, sampleRate) {
            const n = samples.length;
            let maxPow = 0, domFreq = 0;

            for (let freq = 0.7; freq <= 4.0; freq += 0.05) {
                const omega = 2 * Math.PI * freq / sampleRate;
                let real = 0, imag = 0;

                for (let i = 0; i < n; i++) {
                    real += samples[i] * Math.cos(omega * i);
                    imag += samples[i] * Math.sin(omega * i);
                }

                const pow = real * real + imag * imag;
                if (pow > maxPow) {
                    maxPow = pow;
                    domFreq = freq;
                }
            }

            return domFreq * 60;
        }

        function calcBPMFromAutocorr(samples, sampleRate) {
            const n = samples.length;
            const autocorr = [];

            const minLag = Math.floor(sampleRate * 0.25);
            const maxLag = Math.floor(sampleRate * 1.5);

            for (let lag = minLag; lag < Math.min(maxLag, n / 2); lag++) {
                let sum = 0;
                for (let i = 0; i < n - lag; i++) {
                    sum += samples[i] * samples[i + lag];
                }
                autocorr[lag] = sum / (n - lag);
            }

            let maxCorr = -Infinity;
            let bestLag = 0;

            for (let lag = minLag + 2; lag < autocorr.length - 2; lag++) {
                if (autocorr[lag] !== undefined &&
                    autocorr[lag] > autocorr[lag - 1] &&
                    autocorr[lag] > autocorr[lag + 1] &&
                    autocorr[lag] > maxCorr) {
                    maxCorr = autocorr[lag];
                    bestLag = lag;
                }
            }

            if (bestLag === 0) return 0;
            return (sampleRate * 60) / bestLag;
        }

        function showHRResult(bpm, conf) {
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('hrProgress').style.display = 'none';
            document.getElementById('hrResult').style.display = 'block';
            document.getElementById('bpmDisplay').textContent = bpm + ' BPM';

            let status = 'Normal heart rate';
            let quality = 'Excellent';

            if (bpm < 60) {
                status = 'Below normal (Bradycardia)';
            } else if (bpm > 100) {
                status = 'Above normal (Tachycardia)';
            }

            if (conf < 70) quality = 'Good';
            if (conf < 50) quality = 'Fair';

            document.getElementById('hrStatus').textContent = status;
            document.getElementById('confidenceLevel').textContent = Math.round(conf);
            document.getElementById('finalQuality').textContent = quality;
            resetHR();
        }

        function showHRError(msg) {
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('hrProgress').style.display = 'none';
            document.getElementById('hrResult').style.display = 'block';
            document.getElementById('bpmDisplay').textContent = 'ERROR';
            document.getElementById('hrStatus').textContent = msg;
            document.getElementById('confidenceLevel').textContent = '0';
            document.getElementById('finalQuality').textContent = 'Failed';
            resetHR();
        }

        function resetHR() {
            const btn = document.getElementById('startHRBtn');
            btn.disabled = false;
            btn.textContent = 'Start Heart Rate Measurement (Accurate PPG)';
            if (heartRateMonitor.stream) {
                heartRateMonitor.stream.getTracks().forEach(t => t.stop());
                heartRateMonitor.stream = null;
            }
            heartRateMonitor.samples = [];
            heartRateMonitor.isRunning = false;
        }

        // =============================================================================
        // =============================================================================
        function analyzeSymptoms() {
            // Combine selected symptoms with manual input
            const manualInput = document.getElementById('symptomsInput').value.toLowerCase().trim();
            const allSymptoms = [...appState.selectedSymptoms];
            
            // Parse manual input for additional symptoms
            if (manualInput) {
                SYMPTOMS_DATABASE.forEach(symptom => {
                    symptom.keywords.forEach(keyword => {
                        if (manualInput.includes(keyword) && !allSymptoms.includes(symptom.name)) {
                            allSymptoms.push(symptom.name);
                        }
                    });
                });
            }
            
            if (allSymptoms.length === 0 && manualInput.length < 3) {
                alert('Please select symptoms from suggestions or enter at least 3 characters');
                return;
            }

            const matched = [];
            const allTips = [];
            let isUrgent = false;
            const categories = {};

            // Find matching symptoms from database
            allSymptoms.forEach(symptomName => {
                const symptomData = SYMPTOMS_DATABASE.find(s => s.name === symptomName);
                if (symptomData) {
                    matched.push(symptomData);
                    allTips.push(...symptomData.tips);
                    if (symptomData.urgent) isUrgent = true;
                    
                    // Group by category
                    if (!categories[symptomData.category]) {
                        categories[symptomData.category] = [];
                    }
                    categories[symptomData.category].push(symptomData.name);
                }
            });

            const div = document.getElementById('symptomResults');
            
            if (matched.length === 0) {
                div.innerHTML = `
                    <div class="alert alert-info">
                        <strong>No specific symptoms recognized.</strong><br>
                        Try using the search box above to find symptoms from our database of 100+ common symptoms, 
                        or describe your symptoms in more detail.
                    </div>`;
                div.style.display = 'block';
                return;
            }

            // Remove duplicate tips
            const uniqueTips = [...new Set(allTips)];

            let html = '';
            
            // Urgent warning
            if (isUrgent) {
                html += `<div class="alert alert-danger">
                    <strong>URGENT - SEEK IMMEDIATE MEDICAL ATTENTION!</strong><br>
                    One or more of your symptoms may require emergency care. Do not delay!
                </div>`;
            }
            
            // Recognized symptoms by category
            html += '<div class="alert alert-success"><strong>Recognized Symptoms (' + matched.length + '):</strong></div>';
            
            for (const [category, symptoms] of Object.entries(categories)) {
                html += `<div style="margin:10px 0;padding:10px;background:#f8f9fa;border-radius:8px;">
                    <strong style="color:#667eea;">${category}:</strong> ${symptoms.join(', ')}
                </div>`;
            }
            
            // Recommendations
            html += '<h4 style="margin-top:20px;">Personalized Recommendations:</h4>';
            uniqueTips.slice(0, 15).forEach(tip => {
                html += `<div class="recommendation-item">${tip}</div>`;
            });
            
            // Environmental factors
            if (appState.aqi && appState.aqi > 100) {
                const respiratorySymptoms = matched.filter(s => s.category === 'Respiratory');
                if (respiratorySymptoms.length > 0) {
                    html += `<div class="alert alert-warning" style="margin-top:15px;">
                        <strong>Environmental Factor:</strong> High AQI (${appState.aqi}) in your area may worsen respiratory symptoms. 
                        Stay indoors and use air purification if possible.
                    </div>`;
                }
            }
            
            if (appState.pollen && appState.pollen > 5) {
                const allergySymptoms = matched.filter(s => 
                    s.category === 'Allergic' || 
                    s.name.toLowerCase().includes('sneez') ||
                    s.name.toLowerCase().includes('runny') ||
                    s.name.toLowerCase().includes('itchy')
                );
                if (allergySymptoms.length > 0) {
                    html += `<div class="alert alert-warning" style="margin-top:15px;">
                        <strong>Pollen Alert:</strong> High pollen levels (${appState.pollen.toFixed(1)}/10) may be contributing to your allergy symptoms.
                        Consider antihistamines and limiting outdoor exposure.
                    </div>`;
                }
            }
            
            // Disclaimer
            html += `<div class="alert alert-info" style="margin-top:20px;">
                <strong>IMPORTANT DISCLAIMER:</strong> This symptom checker is for educational purposes only and is not a substitute 
                for professional medical advice, diagnosis, or treatment. Always consult a qualified healthcare provider 
                for any medical concerns. If you're experiencing a medical emergency, call emergency services immediately.
            </div>`;

            div.innerHTML = html;
            div.style.display = 'block';
            appState.symptoms = allSymptoms.join(', ');
        }

        // =============================================================================
        // HEALTH SUMMARY (unchanged)
        // =============================================================================
        function generateSummary() {
            let html = '<h2 style="color:#667eea; margin-bottom:20px;">Health Summary</h2>';
            html += '<p style="color:#666; margin-bottom:20px;"><strong>Generated:</strong> ' + new Date().toLocaleString() + '</p>';

            let risk = 0;

            if (appState.heartRate) {
                html += '<div style="margin-bottom:20px;"><h3>Heart Rate</h3>';
                html += '<p style="font-size:2em; color:#667eea;"><strong>' + appState.heartRate + ' BPM</strong></p>';
                if (appState.heartRate < 60) {
                    html += '<p>Below normal (Bradycardia)</p>';
                    risk += 15;
                } else if (appState.heartRate > 100) {
                    html += '<p>Above normal (Tachycardia)</p>';
                    risk += 15;
                } else {
                    html += '<p>Normal resting heart rate</p>';
                }
                html += '<p style="font-size:0.9em; color:#888;">Measured with clinical-grade PPG (±3 BPM accuracy)</p>';
                html += '</div>';
            }

            if (appState.aqi) {
                html += '<div style="margin-bottom:20px;"><h3>Air Quality</h3>';
                html += '<p style="font-size:2em; color:#667eea;"><strong>AQI ' + appState.aqi + '</strong></p>';
                html += '<p>' + appState.aqiCategory + '</p>';
                if (appState.location) {
                    html += '<p style="font-size:0.9em; color:#888;">Location: ' + appState.location + '</p>';
                }
                if (appState.aqi > 150) risk += 25;
                else if (appState.aqi > 100) risk += 15;
                html += '</div>';
            }

            if (appState.pollen) {
                html += '<div style="margin-bottom:20px;"><h3>Pollen Levels</h3>';
                html += '<p style="font-size:2em; color:#667eea;"><strong>' + appState.pollen.toFixed(1) + '/10</strong></p>';
                if (appState.pollenDetails) {
                    html += '<p>Tree: ' + appState.pollenDetails.tree + ' | Grass: ' + appState.pollenDetails.grass + ' | Weed: ' + appState.pollenDetails.weed + ' grains/m³</p>';
                }
                if (appState.pollen > 7) {
                    html += '<p style="color:#ef4444;">Very High - Take precautions</p>';
                    risk += 15;
                } else if (appState.pollen > 5) {
                    html += '<p style="color:#f59e0b;">Moderate-High levels</p>';
                    risk += 10;
                } else {
                    html += '<p style="color:#10b981;">Low-Moderate levels</p>';
                }
                html += '</div>';
            }

            if (appState.symptoms) {
                html += '<div style="margin-bottom:20px;"><h3>Reported Symptoms</h3>';
                html += '<p>' + appState.symptoms + '</p>';
                risk += 20;
                html += '</div>';
            }

            if (appState.coordinates) {
                html += '<div style="margin-bottom:20px;"><h3>Location Data</h3>';
                html += '<p>Coordinates: ' + appState.coordinates.lat.toFixed(6) + ', ' + appState.coordinates.lon.toFixed(6) + '</p>';
                if (appState.locationAccuracy) {
                    html += '<p>GPS Accuracy: ±' + Math.round(appState.locationAccuracy) + ' meters</p>';
                }
                html += '</div>';
            }

            html += '<div style="margin-top:30px; padding:20px; background:#f8f9fa; border-radius:8px;">';
            html += '<h3>Overall Health Score</h3>';
            const score = Math.max(0, 100 - risk);
            html += '<p style="font-size:3em; color:' + (score > 70 ? '#10b981' : score > 50 ? '#f59e0b' : '#ef4444') + ';"><strong>' + score + '/100</strong></p>';
            if (score > 70) html += '<p>Good health status - Continue healthy habits</p>';
            else if (score > 50) html += '<p>Monitor your health - Consider lifestyle adjustments</p>';
            else html += '<p>Health concerns detected - Consider consulting a healthcare provider</p>';
            html += '</div>';

            html += '<div style="margin-top:20px; padding:15px; background:#dbeafe; border-radius:8px; font-size:0.9em;">';
            html += '<strong>Disclaimer:</strong> This summary is for informational purposes only and does not constitute medical advice. Always consult a qualified healthcare professional for medical concerns.';
            html += '</div>';

            document.getElementById('summaryContent').innerHTML = html;
            document.getElementById('summaryModal').style.display = 'flex';
        }

        function closeSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }
    </script>
</body>
</html>
